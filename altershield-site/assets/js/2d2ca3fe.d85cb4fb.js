"use strict";(self.webpackChunkguide=self.webpackChunkguide||[]).push([[23],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=a.createContext({}),p=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(i.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(n),m=r,h=d["".concat(i,".").concat(m)]||d[m]||u[m]||l;return n?a.createElement(h,o(o({ref:t},c),{},{components:n})):a.createElement(h,o({ref:t},c))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,o=new Array(l);o[0]=m;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s[d]="string"==typeof e?e:r,o[1]=s;for(var p=2;p<l;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},5046:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>o,default:()=>u,frontMatter:()=>l,metadata:()=>s,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const l={},o="User Guide",s={unversionedId:"altershield-operator/user-guide",id:"altershield-operator/user-guide",title:"User Guide",description:"This document introduces the user guide for AlterShield Operator.",source:"@site/docs/05-altershield-operator/05-user-guide.md",sourceDirName:"05-altershield-operator",slug:"/altershield-operator/user-guide",permalink:"/altershield-operator/user-guide",draft:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Quick Deploy",permalink:"/altershield-operator/quick-deploy"},next:{title:"Advanced Usage",permalink:"/altershield-operator/advanced-usage"}},i={},p=[{value:"Getting Started",id:"getting-started",level:2},{value:"Basic Principles of AlterShield Operator",id:"basic-principles-of-altershield-operator",level:2},{value:"1.  Create a Deployment Resource Sleep",id:"1--create-a-deployment-resource-sleep",level:2},{value:"2. Check if the deployment is successful",id:"2-check-if-the-deployment-is-successful",level:2},{value:"3. Observe the yaml of deployment sleep in the cluster",id:"3-observe-the-yaml-of-deployment-sleep-in-the-cluster",level:2},{value:"4. Observe the ChangeWorkload CR resource in the cluster",id:"4-observe-the-changeworkload-cr-resource-in-the-cluster",level:2},{value:"5. Wait for AlterShield Operator to complete the runtime check",id:"5-wait-for-altershield-operator-to-complete-the-runtime-check",level:2},{value:"6. Observe the ChangePod CR resources in the cluster",id:"6-observe-the-changepod-cr-resources-in-the-cluster",level:2}],c={toc:p},d="wrapper";function u(e){let{components:t,...n}=e;return(0,r.kt)(d,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"user-guide"},"User Guide"),(0,r.kt)("p",null,"This document introduces the user guide for AlterShield Operator."),(0,r.kt)("h2",{id:"getting-started"},"Getting Started"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Before running AlterShield Operator, you need to read the following documents:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"./quick-deploy"},"Quick Deploy")," and run it on the cluster.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Before using AlterShield Operator, you need to understand the following concepts:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/reference/kubernetes-api/extend-resources/custom-resource-definition-v1/"},"CustomResourceDefinition")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/reference/access-authn-authz/webhook/"},"Webhook Mode"))),(0,r.kt)("h2",{id:"basic-principles-of-altershield-operator"},"Basic Principles of AlterShield Operator"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Based on the Kubernetes Webhook and Watch mechanisms, AlterShield Operator monitors Kubernetes resources."),(0,r.kt)("li",{parentName:"ul"},"Defining two brand-new CRD resources, ChangeWorkload and ChangePod, to define the monitoring information for Workload and Pod resources."),(0,r.kt)("li",{parentName:"ul"},"When a Deployment resource in the cluster changes, AlterShield Operator detects the changed resource. If an exception is detected, it intercepts future changes to the abnormal resource while triggering self-healing rollback.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Next, try to use AlterShield Operator further")),(0,r.kt)("h2",{id:"1--create-a-deployment-resource-sleep"},"1.  Create a Deployment Resource Sleep"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: sleep\n  labels:\n    app: sleep\nspec:\n  replicas: 5\n  selector:\n    matchLabels:\n      app: sleep\n  template:\n    metadata:\n      labels:\n        app: sleep\n        test: "123"\n    spec:\n      containers:\n        - name: sleep\n          image: busybox\n          command: ["/bin/sleep","infinity"]\n          imagePullPolicy: IfNotPresent\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Run the command")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl apply -f config/samples/sleep.yaml\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"When you see the following log, the deployment is complete")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"deployment.apps/sleep created\n")),(0,r.kt)("h2",{id:"2-check-if-the-deployment-is-successful"},"2. Check if the deployment is successful"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Run the command")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl get pods\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"When you see 5 sleep pods running, it means the deployment was successful.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"NAME                     READY   STATUS    RESTARTS   AGE\nsleep-5c698f4449-8q79v   1/1     Running   0          2m\nsleep-5c698f4449-fsb27   1/1     Running   0          2m\nsleep-5c698f4449-gttrk   1/1     Running   0          2m\nsleep-5c698f4449-mllt2   1/1     Running   0          2m\nsleep-5c698f4449-qv24p   1/1     Running   0          2m\n")),(0,r.kt)("h2",{id:"3-observe-the-yaml-of-deployment-sleep-in-the-cluster"},"3. Observe the yaml of deployment sleep in the cluster"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Run the command")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl get deployment sleep -o yaml\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Unlike Running Local Server in ",(0,r.kt)("a",{parentName:"li",href:"./quick-start"},"Quick-Start"),"\uff0cyou will find two more labels in the yaml of Deployment sleep in the cluster.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nitems:\n  - apiVersion: apps/v1\n    kind: Deployment\n    metadata:\n      annotations:\n        deployment.kubernetes.io/revision: "6"\n        kubectl.kubernetes.io/last-applied-configuration: ...\n      creationTimestamp: ...\n      generation: 6\n      labels:\n        admission-webhook-altershield.antgroup.com/version: c6c45d23c098bdf181853a85b60b5d74\n        altershield.defense.antgroup.com/defense-status: processed\n        app: sleep\n      name: sleep\n      namespace: default\n      resourceVersion: "196532"\n      uid: 63e253a2-d18a-4100-b928-38e004263762\n    spec:\n      progressDeadlineSeconds: 600\n      replicas: 5\n      revisionHistoryLimit: 10\n      selector:\n        matchLabels:\n          app: sleep\n      strategy:\n        rollingUpdate:\n          maxSurge: 25%\n          maxUnavailable: 25%\n        type: RollingUpdate\n      template:\n        metadata:\n          creationTimestamp: null\n          labels:\n            admission-webhook-altershield.antgroup.com/version: c6c45d23c098bdf181853a85b60b5d74\n            app: sleep\n            test: "123"\n        spec: ...\n    status:\n      availableReplicas: 5\n      conditions:\n        - lastTransitionTime: ...\n        - lastTransitionTime: ...\n      readyReplicas: 5\n      replicas: 5\n      updatedReplicas: 5\nkind: List\nmetadata:\n  resourceVersion: ""\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Find one more label ",(0,r.kt)("inlineCode",{parentName:"li"},"admission-webhook-altershield.antgroup.com/version")," in the metadata.labels of deployment."),(0,r.kt)("li",{parentName:"ul"},"Find one more label ",(0,r.kt)("inlineCode",{parentName:"li"},"admission-webhook-altershield.antgroup.com/version")," in the spec.template.metadata.labels of deployment.")),(0,r.kt)("p",null,"This is added by AlterShield Operator for deployment, used to identify that your deployment has been processed by AlterShield Operator and generates a version number according to the template."),(0,r.kt)("h2",{id:"4-observe-the-changeworkload-cr-resource-in-the-cluster"},"4. Observe the ChangeWorkload CR resource in the cluster"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Run the command")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl get changeworkload -o yaml\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nitems:\n  - apiVersion: app.ops.cloud.alipay.com/v1alpha1\n    kind: ChangeWorkload\n    metadata:\n      creationTimestamp: "2023-05-11T07:24:12Z"\n      generation: 1\n      labels:\n        admission-webhook-altershield.antgroup.com/version: c6c45d23c098bdf181853a85b60b5d74\n        app.kubernetes.io/deployment-name: sleep\n      name: sleep--x--c6c45d23c098bdf181853a85b60b5d74\n      namespace: default\n      ownerReferences:\n        - apiVersion: apps/v1\n          blockOwnerDeletion: true\n          controller: true\n          kind: Deployment\n          name: sleep\n          uid: 57719e7d-fcae-4667-8e93-217184afe5a3\n      resourceVersion: "197374"\n      uid: 2405c4f9-e811-400c-a104-283cee03a2d8\n    spec:\n      appName: sleep\n      changeWorkloadId: sleep--x--c6c45d23c098bdf181853a85b60b5d74\n      countThreshold: 1\n      createTime: "2023-05-11 07:24:12"\n      createTimeUnix: 1683789852\n      reversion: c6c45d23c098bdf181853a85b60b5d74\n      serviceName: sleep\n      waitTimeThreshold: 60\nkind: List\nmetadata:\n  resourceVersion: ""\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Find that AlterShield Operator has created a ChangeWorkload resource for the ",(0,r.kt)("strong",{parentName:"li"},"c6c45d23c098bdf181853a85b60b5d74")," version of deployment sleep, named ",(0,r.kt)("strong",{parentName:"li"},"sleep--x--c6c45d23c098bdf181853a85b60b5d74"),".")),(0,r.kt)("h2",{id:"5-wait-for-altershield-operator-to-complete-the-runtime-check"},"5. Wait for AlterShield Operator to complete the runtime check"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"For details on the runtime check, please refer to ",(0,r.kt)("a",{parentName:"strong",href:"../open-change-management-specification/overview"},"Open Change Management Specification"))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"When the runtime check is completed, you will find some additional information in the status field of the ChangeWorkload resource")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Run the command")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl get changeworkload -o yaml\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Observe the output")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nitems:\n  - apiVersion: app.ops.cloud.alipay.com/v1alpha1\n    kind: ChangeWorkload\n    metadata: ...\n    spec: ...\n    status:\n      defenseCheckPassPods:\n        - app: sleep\n          hostName: sleep-5c698f4449-fsb27\n          ip: 10.244.1.198\n          namespace: default\n          pod: sleep-5c698f4449-fsb27\n          workSpace: default\n        - app: sleep\n          hostName: sleep-5c698f4449-gttrk\n          ip: 10.244.1.201\n          namespace: default\n          pod: sleep-5c698f4449-gttrk\n          workSpace: default\n        - app: sleep\n          hostName: sleep-5c698f4449-8q79v\n          ip: 10.244.1.202\n          namespace: default\n          pod: sleep-5c698f4449-8q79v\n          workSpace: default\n        - app: sleep\n          hostName: sleep-5c698f4449-mllt2\n          ip: 10.244.1.199\n          namespace: default\n          pod: sleep-5c698f4449-mllt2\n          workSpace: default\n        - app: sleep\n          hostName: sleep-5c698f4449-qv24p\n          ip: 10.244.1.200\n          namespace: default\n          pod: sleep-5c698f4449-qv24p\n          workSpace: default\n      entryTime: "2023-05-11 15:46:15"\n      entryTimeUnix: 1683791175\n      status: Success\n      updateTime: "2023-05-11 15:46:19"\n      updateTimeUnix: 1683791179\nkind: List\nmetadata:\n  resourceVersion: ""\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"defenseCheckPassPods: represents the list of Pods that have completed the run detection and have passed the AlterShield Operator detection."),(0,r.kt)("li",{parentName:"ul"},"When the number of Pods in defenseCheckPassPods reaches the replicas number in the deployment, the AlterShield Operator will set the ",(0,r.kt)("strong",{parentName:"li"},"status")," field of the ",(0,r.kt)("strong",{parentName:"li"},"ChangeWorkload")," resource to ",(0,r.kt)("strong",{parentName:"li"},"Success"),", indicating that the current version has been successfully released.")),(0,r.kt)("h2",{id:"6-observe-the-changepod-cr-resources-in-the-cluster"},"6. Observe the ChangePod CR resources in the cluster"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Run the command:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl get changepods | grep sleep\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Observe the output:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"NAME                                               STATUS        MESSAGE     CREATETIME\nsleep--x--c6c45d23c098bdf181853a85b60b5d74--x--1   ExecuteDone   PreFailed   2023-05-11 15:46:13\nsleep--x--c6c45d23c098bdf181853a85b60b5d74--x--2   ExecuteDone   PreFailed   2023-05-11 15:46:14\nsleep--x--c6c45d23c098bdf181853a85b60b5d74--x--3   ExecuteDone   PreFailed   2023-05-11 15:46:14\nsleep--x--c6c45d23c098bdf181853a85b60b5d74--x--4   ExecuteDone   PreFailed   2023-05-11 15:46:15\nsleep--x--c6c45d23c098bdf181853a85b60b5d74--x--5   ExecuteDone   PreFailed   2023-05-11 15:46:15\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The AlterShield Operator has created 5 ",(0,r.kt)("strong",{parentName:"li"},"ChangePod")," resources for version ",(0,r.kt)("strong",{parentName:"li"},"c6c45d23c098bdf181853a85b60b5d74")," of deployment sleep."),(0,r.kt)("li",{parentName:"ul"},"By default, the AlterShield Operator creates a ",(0,r.kt)("strong",{parentName:"li"},"ChangePod")," resource for each Pod in the deployment."),(0,r.kt)("li",{parentName:"ul"},"The name format of the ChangePod resource is ",(0,r.kt)("strong",{parentName:"li"},"{deployment name}--x--{version}--x--{index}"),"."),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("strong",{parentName:"li"},"status")," field of the ChangePod resource is ",(0,r.kt)("strong",{parentName:"li"},"ExecuteDone"),", indicating that the run detection has been completed."),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("strong",{parentName:"li"},"message")," field of the ChangePod resource is ",(0,r.kt)("strong",{parentName:"li"},"PreFailed"),", indicating that the detection failed to perform (requires configuring the",(0,r.kt)("a",{parentName:"li",href:"../open-change-management-specification/overview"},"Open Change Management Specification"),"\uff09"),(0,r.kt)("li",{parentName:"ul"},"A failed execution does not necessarily mean a failed release. Only if an Pod exception is detected during the detection, it will be considered a release failure.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"In the current scenario, all ChangePods failed to execute, and no exceptions were found. The reason why the ChangeWorkload regards the release as successful is that it assumes all Pods have passed the detection.")))}u.isMDXComponent=!0}}]);