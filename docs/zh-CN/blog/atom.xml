<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://traas-stack.github.io/zh-CN/blog</id>
    <title>AlterShield Blog</title>
    <updated>2024-04-16T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://traas-stack.github.io/zh-CN/blog"/>
    <subtitle>AlterShield Blog</subtitle>
    <icon>https://traas-stack.github.io/zh-CN/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[「MeetUp」AlterShield x 国泰君安 x 滴滴 x 富途]]></title>
        <id>https://traas-stack.github.io/zh-CN/blog/meetup-20240416</id>
        <link href="https://traas-stack.github.io/zh-CN/blog/meetup-20240416"/>
        <updated>2024-04-16T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[AlterShield社区从3月份开始筹备，于4月16日 1000举办了一次比较大的线上MeetUp。]]></summary>
        <content type="html"><![CDATA[<blockquote><p>AlterShield社区从3月份开始筹备，于<code>4月16日 10:00-12:00</code>举办了一次比较大的线上MeetUp。
其中参与的公司有国泰君安、同程旅行、滴滴出行、富途科技，线上参会人数共计25人。</p></blockquote><p><strong>MeetUp议程如下：</strong></p><ol><li>蚂蚁集团俞灏宣分享《变更管控的方法与智能化实践》
<img loading="lazy" src="/zh-CN/assets/images/1-dd54281f9dff26a8cf4b303db61327a5.png" width="1500" height="1018" class="img_ev3q"></li><li>富途科技肖先敏分享了富途的变更管控现状以及主要的低效点
<img loading="lazy" src="/zh-CN/assets/images/2-d39891df9bf09d4647ea6e6a846b86c4.png" width="1500" height="850" class="img_ev3q"></li><li>同程旅行刘明松（运维研发负责人，故障生命周期研发负责人）分享了同程旅行内部变更管控的现状以及问题和痛点
<img loading="lazy" src="/zh-CN/assets/images/3-a30f2e35caa4181fb87476f572758610.png" width="1500" height="949" class="img_ev3q"><img loading="lazy" src="/zh-CN/assets/images/4-da4681843cd8beadef11a4f609486b3a.png" width="1500" height="969" class="img_ev3q"></li><li>滴滴吉原杰分享了内部目前的一些痛点和诉求
<img loading="lazy" src="/zh-CN/assets/images/5-30c3d158ac77b13d0bc5f34834f5fd27.png" width="488" height="224" class="img_ev3q"></li><li>国泰君安郭建华分享了内部变更管控现状以及一些探讨问题
<img loading="lazy" src="/zh-CN/assets/images/6-c80126188614a995f03ed1185c0c0d18.png" width="1500" height="875" class="img_ev3q"></li></ol><p>后续大家集思广益针对上述问题展开了探讨，相关问题讨论详情见下面。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题讨论">问题讨论<a href="#问题讨论" class="hash-link" aria-label="问题讨论的直接链接" title="问题讨论的直接链接">​</a></h2><ol><li><p>变更影响上下游如何分析的？</p><p>静态程序分析：代码逻辑的影响（接口、db表、sql）。<br>
<!-- -->动态分析：流量链路分析，元数据拓扑推导等等。</p></li><li><p>CMDB数据准确率？缺失或者实效性不够是否影响风险分析效果？</p><p>会影响结果，作为中心化系统应该保证SLA。</p></li><li><p>变更前置、后置校验会校验哪些项？具体有什么策略？</p><p>变更前：封网、窗口（可自动化）、饭点管控、业务链路故障检测、容量水位监测、配置变更校验。</p><p>变更后：监控（系统通用指标、业务指标）、日志、链路。 </p><p>变更完整性：配置推送是否成功。</p><p>策略均以Faas化方式提供（规则化）。</p></li><li><p>灰度是如何做的？</p><p>灰度环境，灰度sdk，拉线上流量做内灰（员工、压测流量）</p></li><li><p>券商业务（闭市后无流量）有什么建设变更管控的建议？</p><p>券商比较适合做仿真环境的建设（周内录制、周末回放验证）。</p></li><li><p>如何确保可回滚？回滚依赖问题？</p><p>发布时填写回滚镜像id，计划阶段统计变更顺序依赖，配置回滚代码化。</p></li><li><p>蚂蚁集团目前的容器化比例？</p><p>目前100%容器化，主要区分在于是否workload化。</p></li><li><p>变更可观测点如何选取策略是怎样的？</p><p>应用监控：CPU、Load、Mem（沉淀历史经验）。
业务监控：根据业务语义做环比校验。</p></li><li><p>运维本身的变更，应当如何激励管理员（运维人员）将日常工作变更化？</p><p>场景不同，蚂蚁有SRE角色。风险把控方式，降低运维人员的风险恐惧。</p></li><li><p>复杂系统场景，如何做关联系统变更？</p><p>跨系统依赖顺序问题 -&gt; 流量采集、仿真流量回放。
配置相关问题：依赖人工事前在计划阶段编排。</p></li><li><p>OCMS中的G0、G1代纪分级的依据？</p><p>根据管控力度区分，不同变更风险程度不同。其中G0只需要做一个变更同步通知即可，而G1需要分批变更管控。</p></li><li><p>接入工作阻力？业务配置变更平台覆盖程度？</p><p>阻力非常大，目前接了 90% 以上，后续新增或评估风险较小的平台未接，通过制定规范、和责任承担机制驱动大家主动接入。</p></li><li><p>蚂蚁集团建设变更管控的故障下降情况如何？</p><p>变更故障占比下降了50%以上。</p></li><li><p>是否有效率上的提升？为什么会降低？</p><p>初期一定是降低效率的，分批管控以及每个批次的观测时间导致初期效率降低。</p></li><li><p>是否对所有的变更强制要求分批？分批变更的占比？</p><p>分批比例：70%-80%。是否强制取决于变更的业务形态。</p></li><li><p>在变更管控建设之后，仍然会有新的变更系统的出现，如何防退化？</p><p>人力（SRE）跟进梳理，挖掘分母完成接入，目前还在探索变更自动感知接入。</p></li><li><p>监控数据的自动识别如何判断出异常？以及降噪？</p><p>通过对变更机器变更前后监控数据进行比对，KDE算法提供特征。通过对照组、历史组方式进行降噪处理。</p></li><li><p>变更目标出现冲突如何解决？</p><p>针对变更目标添加路障锁。</p></li><li><p>蚂蚁集团的变更管控部署架构是怎样的？是否是中心化的？</p><p>目前是多云多站点模式，数据隔离。是一个中心化的系统。</p></li><li><p>变更类故障的占比情况？</p><p>量级有所降低，但是比例依旧较高（并非所有变更引发的问题都能发现，如历史问题暴雷）。</p></li><li><p>故障发生时的定位是否有体现？</p><p>变更搜索机制，快速检索。主动定位由更专业的变更定位团队负责此部分工作。</p></li><li><p>事前的策略有哪些？</p><p>风险分析辅助推导，事后的话强依赖分批能力。</p></li><li><p>目前有哪些方式做阻断方式？</p><p>平台调用 -&gt; 变更管控 -&gt; 平台回调。</p></li></ol>]]></content>
        <author>
            <name>Yalong Jin</name>
            <uri>https://github.com/jinyalong</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[「MeetUp」AlterShield x 理想]]></title>
        <id>https://traas-stack.github.io/zh-CN/blog/meetup-20240319</id>
        <link href="https://traas-stack.github.io/zh-CN/blog/meetup-20240319"/>
        <updated>2024-03-19T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[理想与AlterShield社区的同学于 3月19日1000通过线上腾讯会议的方式进行了一轮交流。]]></summary>
        <content type="html"><![CDATA[<blockquote><p>理想与AlterShield社区的同学于 <code>3月19日10:00-12:00</code>通过线上腾讯会议的方式进行了一轮交流。</p><p>理想参与的同学有稳定性平台的技术、产品同学。参会人数共计10人。
<img loading="lazy" src="/zh-CN/assets/images/3-c4078c97dae9a089e9a981792d22e9d2.png" width="1500" height="1018" class="img_ev3q"></p></blockquote><p>MeetUp议程如下：</p><ol><li>俞灏宣分享了《变更管控的方法与智能化实践》
<img loading="lazy" src="/zh-CN/assets/images/1-dd54281f9dff26a8cf4b303db61327a5.png" width="1500" height="1018" class="img_ev3q"></li><li>对分享内容展开了一系列问题讨论</li></ol><p><img loading="lazy" src="/zh-CN/assets/images/2-55f41874eaf2676648308e025f6702be.png" width="1500" height="740" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="问题讨论">问题讨论<a href="#问题讨论" class="hash-link" aria-label="问题讨论的直接链接" title="问题讨论的直接链接">​</a></h2><ol><li><p>日志标准化改造，推行变更管控遇到的阻力。</p><p>中间件定义日志规范，业务定义日志规范，统一日志的格式，方便日志切割以及监控的配置。</p></li><li><p>为啥要做变更管控平台，背景是什么？</p><p>分析蚂蚁历史故障根因，发现大多数（至少70%）是因为变更引起的故障，因此如果能够将变更有效的管控起来，通过一些技术手段能够降低或者防控住变更过程中的风险将会是一件收益很大的事。</p></li><li><p>接入到被管控整个流程，涉及哪些角色？</p><p>接入前：
接入后：</p></li><li><p>后续的规划以及方向？</p><p>变更的管控和效率是冲突的两件事，虽然风险降低了，但同时效率也降低了，技术手段相对成熟之后，可以探索无人值守方向以提高变更管控的效率。
PAC（Policy As Code）将在后续的云原生领域的Operator中发布该部分能力，主要解决的是云原生场景下一站式的变更管控平台，所有变更管控策略均是通过声明式编码的方式实现。</p></li><li><p>时序校验算法是使用传统的算法来实现吗？</p><p>这部分是基于传统的一些时序异常检测算法来做工程化的接入实践的，经验证是一种行之有效的手段。</p></li><li><p>变更平台接入的成本？</p><p>单个变更平台约1～2周左右，取决于变更平台的复杂性以及自身架构设计是否灵活。</p></li><li><p>团队规模不够大，如何低成本做变更管控？</p><p>基于开源版本建设，节省变更管控能力本身建设的时间成本，节省变更防御体系框架能力的一些建设成本。
对于运营、改造接入这种成本没办法节省。</p></li><li><p>开源的版本功能有哪些？</p><p>下图中蓝色部分均已开源，产品功能目前没有前端UI，主要以接口的方式提供服务。
<img loading="lazy" src="/zh-CN/assets/images/4-2d04d4dab1f8a709d644e46534e20fd4.png" width="1500" height="788" class="img_ev3q"></p></li><li><p>运营落地的一些方法论？</p><p>让别人看到变更管控的效果，自上而且的推动。</p></li><li><p>核心价值的指标是什么？</p><p>变更故障数的减少。</p></li></ol>]]></content>
        <author>
            <name>Yalong Jin</name>
            <uri>https://github.com/jinyalong</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[「MeetUp」AlterShield x 唯品会]]></title>
        <id>https://traas-stack.github.io/zh-CN/blog/meetup-20231226</id>
        <link href="https://traas-stack.github.io/zh-CN/blog/meetup-20231226"/>
        <updated>2023-12-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[受唯品会同学的邀请，12月26日 1500 AlterShield社区同学同唯品会的同学通过线上腾讯会议的方式进行了一轮交流。]]></summary>
        <content type="html"><![CDATA[<blockquote><p>受唯品会同学的邀请，<code>12月26日 15:00-17:00</code> AlterShield社区同学同唯品会的同学通过线上腾讯会议的方式进行了一轮交流。</p><p>参与的同学有唯品会基础架构效能部同学以及蚂蚁集团AlterShield开源社区负责人金亚龙、俞灏宣、付锦飞。</p></blockquote><p>MeetUp议程如下：</p><ol><li>唯品会分享变更内部实践，以及实践过程中遇到的一些问题和比较关注AlterShield能力的部分</li><li>金亚龙分享AlterShield目前开放v1.0版本的能力现状和特性</li><li>结合前面分享针对下面问题展开了重点讨论<ul><li>变更影响面的建设思路</li><li>变更协议代际的一些设计考量</li><li>防御规则体系建设经验</li><li>防御框架设计与实现</li></ul></li></ol><h1>防御规则体系建设的方法论</h1><p>1.故障牵引建设防御体系往往是比较有效的方式</p><p>2.形成完备的机制以应对一个新的故障发生的时候，有行之有效的手段来建设起对应的防御能力，防止同类根因故障的再次发生。</p><h1>防御框架设计与实现</h1><p><img loading="lazy" alt="img.png" src="/zh-CN/assets/images/1-4ba9d7a8b92e5245387fe73dc4013732.png" width="1080" height="361" class="img_ev3q">
防御框架层提供的核心能力包括下面三个部分：</p><ol><li>防御规则的路由和匹配（router）</li><li>防御能力的并发执行（invoke）</li><li>防御能力异步化（sync）</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="自研简易高效规则引擎---与或表达式">自研简易高效规则引擎 - 与或表达式<a href="#自研简易高效规则引擎---与或表达式" class="hash-link" aria-label="自研简易高效规则引擎 - 与或表达式的直接链接" title="自研简易高效规则引擎 - 与或表达式的直接链接">​</a></h2><p>左值匹配与或表达式执行逻辑</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="防御能力并发执行">防御能力并发执行<a href="#防御能力并发执行" class="hash-link" aria-label="防御能力并发执行的直接链接" title="防御能力并发执行的直接链接">​</a></h2><p>基于事件中心的分布式调度。详情见主端的Schedule模块</p><p>👉<a href="https://github.com/traas-stack/altershield/tree/main/src/altershield-schedule" target="_blank" rel="noopener noreferrer">AlterShield-schedule</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="防御能力异步化">防御能力异步化<a href="#防御能力异步化" class="hash-link" aria-label="防御能力异步化的直接链接" title="防御能力异步化的直接链接">​</a></h2><p>基于事件中心分布式调度</p><p>👉<a href="https://github.com/traas-stack/altershield/tree/main/src/altershield-schedule" target="_blank" rel="noopener noreferrer">AlterShield-schedule</a></p>]]></content>
        <author>
            <name>Yalong Jin</name>
            <uri>https://github.com/jinyalong</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[AlterShield V1.0 正式发布]]></title>
        <id>https://traas-stack.github.io/zh-CN/blog/altershield-v1.0</id>
        <link href="https://traas-stack.github.io/zh-CN/blog/altershield-v1.0"/>
        <updated>2023-12-14T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[AlterShield 是一款能够有效进行变更风险防控，预防变更引发生产环境故障的变更管控解决方案。]]></summary>
        <content type="html"><![CDATA[<blockquote><p>AlterShield 是一款能够有效进行变更风险防控，预防变更引发生产环境故障的变更管控解决方案。
它是蚂蚁集团内部变更管控平台 OpsCloud 的开源版本。它凝聚了蚂蚁集团在公司大规模变更下积累的变更管控技术、产品以及方法论。在复杂业务场景下，提供变更过程中的生命周期感知、变更防御、变更熔断能力。</p></blockquote><p>AlterShield主端代码仓库github地址：<a href="https://github.com/traas-stack/altershield" target="_blank" rel="noopener noreferrer">https://github.com/traas-stack/altershield</a></p><p>AlterShield-operator仓库github地址：<a href="https://github.com/traas-stack/altershield-operator" target="_blank" rel="noopener noreferrer">https://github.com/traas-stack/altershield-operator</a></p><p>AlterShield-monitorCheck仓库github地址：<a href="https://github.com/traas-stack/altershield-monitorCheck" target="_blank" rel="noopener noreferrer">https://github.com/traas-stack/altershield-monitorCheck</a></p><p>开源项目官网：<a href="https://altershield.io/" target="_blank" rel="noopener noreferrer">https://altershield.io/</a></p><h1>01、背景介绍</h1><p>AlterShield在今年6月份发布v0.1版本之后，一直沉寂了很长一段时间。因为我们也不确定在蚂蚁内部的这一套变更管控的实践方案是否真的是大家想要的，大家所需要的。想要管控变更首先需要对变更有一个清楚的定义，在蚂蚁集团内部多年的实践经验来看，我们沉淀了一套变更管控描述变更的标准信息模型-Open Change Management Specification。在v0.1版本中开源了SDK模块以及整个变更管控系统设计架构之后，我们与SRE领域内一些经验比较丰富的同学进行了多次深入交流。</p><ul><li>今年6月份举行了第一次线下MeetUp，在与联通软件研究院、bilibili的同学交流中，大家都认为变更管控是非常重要的，并且都很关心变更管控如何接入实践。</li><li>随后在7月份同美团、oppo的稳定性领域从事相关工作的同学举行了一次线上的MeetUp，大家聚在一起讨论了变更管控的价值以及业界比较关心的变更防控智能化。</li><li>9月份我们去往同花顺的总部(杭州)，与同花顺的SRE领域内同学进行了一次线下交流。大家也是对变更管控的实践、价值和智能化比较感兴趣。同时还探讨了变更防控与当前火爆的LLM技术是否有一些结合或者实践。</li></ul><p>这半年来，我们与行业内多达10+公司的相关领域内同学做了比较深入的交流，其中有金融属性的公司、也有互联网属性的公司。大家或多或少都经历过一些重大的因为变更引起的故障，稳定性一直是一个重要命题，守正才能出奇。由变更引发的故障更是数不胜数，因此如果能够把变更引发的风险通过有效的技术手段、智能化手段降低将会是一件非常有价值的事。</p><p>经过长达半年的努力，我们将内部的变更管控系统OpsCloud（SofaBoot技术栈）基于开源社区比较受欢迎的SpringBoot框架完全重构设计，去除迭代了多年引入的一些历史包袱以及糟糠代码。同时我们从0到1设计了一个用于感知云原生场景下的变更的operator应用，提供了一套通用的workload防控框架，将变更管控的范围扩展到了云原生场景。</p><p>智能化变更防控手段也是大家比较感兴趣的一个命题，本次v1.0版本同时发布了蚂蚁内部自主研发的一些算法服务。</p><h1>02、新版本重点解读</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一主端最小可运行完整版本发布">一、主端最小可运行完整版本发布<a href="#一主端最小可运行完整版本发布" class="hash-link" aria-label="一、主端最小可运行完整版本发布的直接链接" title="一、主端最小可运行完整版本发布的直接链接">​</a></h2><p><img loading="lazy" src="/zh-CN/assets/images/1-d64783aa7fb25ec1e557fb20b66b813b.png" width="1500" height="788" class="img_ev3q"></p><p>v0.1版本发布了：OCMS-SDK、AlterShield Operator</p><p>本次v1.0版本开源了上图中：</p><ul><li>DefenseFramework变更防御框架</li><li>变更技术协议</li><li>开放扩展能力</li><li>事件调度</li></ul><blockquote><p>主端模块介绍</p><ul><li>altershield-bootstrap：启动模块</li><li>altershield-change模块：变更技术协议模块</li><li>altershield-common模块：通用的服务、工具类模块</li><li>altershield-defender模块：变更防御框架</li><li>altershield-framework-sdk模块：OCMS SDK</li><li>altershield-framwork-spi模块：开放扩展模块</li><li>altershield-plugin-market模块：开放扩展模块的调度中心（调度内部实现的SPI或外部打包上传的插件）</li><li>altershield-schedule模块：altershield的底层组件，基于数据库实现的两层事件分发调度中心</li><li>altershield-shared模块：模块间共享的服务</li><li>altershield-web模块：对外的http接口（SDK接入 &amp; DashBoard接口）</li></ul></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二智能变更防御算法服务">二、智能变更防御算法服务<a href="#二智能变更防御算法服务" class="hash-link" aria-label="二、智能变更防御算法服务的直接链接" title="二、智能变更防御算法服务的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="背景介绍">背景介绍<a href="#背景介绍" class="hash-link" aria-label="背景介绍的直接链接" title="背景介绍的直接链接">​</a></h3><p>在云原生大型在线服务系统中，微服务系统中软件变更行为频繁发生。在软件变更期间，引入新代码、更改配置或更改代码的行为，都可能会引起服务中断和生产事故，从而破坏用户体验、引起用户不满，这将带来巨大的经济损失。根据Google SRE的运维经验，大约 70%事件与软件变更有关。曾经，Facebook出现严重的宕机行为，全网宕机近七小时。因此，快速识别软件异常变更，降低事故影响，提高系统的可靠性，成了软件运维的重要事情。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="技术方案">技术方案<a href="#技术方案" class="hash-link" aria-label="技术方案的直接链接" title="技术方案的直接链接">​</a></h3><p>在发布流程中，往往会采取研发/SRE/运维同学盯盘监控的方式进行业务分批发布上线，这样可以在业务出现分析概念时能够及时被监控到并进行业务止血操作，防止变更引入的风险进一步扩大，从而影响到大量用户。而在蚂蚁内部，依托于变更管控平台，我们提供了一种可实现变更时自动盯盘变更应用监控项的能力：智能分批监控校验。该监控盯盘能力主要是根据变更应用获取其相关监控项，并在某批次机器变更「如应用发布、配置推送」后对该批次变更机器变更前后的监控时序数据进行异常检测。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="整体架构">整体架构<a href="#整体架构" class="hash-link" aria-label="整体架构的直接链接" title="整体架构的直接链接">​</a></h3><p>在蚂蚁集团内部，「智能分批监控校验」服务依托于MaaS、Pontus、Alarm GS等相关基础服务运行，分别承担整个校验逻辑中的监控项下发、数据采集通知、监控数据拉取等能力。考虑到以上服务暂未有开源计划，同时我们有意向将「智能分批监控校验」此能力开源，所以针对整条校验链路进行了二次重写。</p><p><strong>重写前项目架构：</strong></p><p><img loading="lazy" src="/zh-CN/assets/images/2-82e47a294b09f4e0447b1ddb86fd9540.png" width="937" height="681" class="img_ev3q"></p><p><strong>重写后项目架构：</strong></p><p>变更平台 - AlterShield 接入 - AlterShield 防御 - Plugin「轮询」- Metrics Client - BatchMonitorCheck</p><p><img loading="lazy" src="/zh-CN/assets/images/3-f6777fabec22344d9d38ed66767d245e.png" width="1372" height="658" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="异常校验">异常校验<a href="#异常校验" class="hash-link" aria-label="异常校验的直接链接" title="异常校验的直接链接">​</a></h3><p>在变更监控的算法实践中，我们核心的要解决的问题是短时序的异常检测。一条待检测的数据通常包含变更前 30 分钟的时序，和变更后 5 ~ 15 分钟的时序，理论上一次正常的变更，系统指标在变更完成后会恢复和变更前一样的状态。为什么是检测数据是短时序，原因有以下：</p><ul><li>因果关系，我们只是为了检测变更前后状态是否有异常，参考变更前太长数据并无意义。</li><li>变更效率，机器的变更都是分 n 批次串行进行的，后置校验每增加 1 分钟，整体变更时间变慢就会放大 n 倍，变更后校验不能太久否则会影响业务变更效率。</li></ul><p>面对这种短时序的异常检测，实践过程中面临主要问题有：</p><ul><li>时序数据太短，且无历史标签。短时序意味着关于变更能利用的信息量小，同时由于数据建设的原因，相对海量变更几乎没有真实标记什么是真实变更问题，无论是算法设计和算法验证都难以开展，巧妇难为无米之炊，算法选型的余地非常小。</li><li>噪声，变更中的短时序抖动是经常出现的现象，这种抖动很容易被算法识别拦截，但识别出来的又通常是噪声。噪声太多导致平台侧没有精力对拦截案例进行分析，也会严重影响用户体验与变更效率。</li></ul><p>目前我们对于变更监控的智能识别方式，主要依靠 KDE 算法和特征统计方法「基于经验的特征设计」。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1监控异常检测之--kde">1、监控异常检测之 -「KDE」<a href="#1监控异常检测之--kde" class="hash-link" aria-label="1、监控异常检测之 -「KDE」的直接链接" title="1、监控异常检测之 -「KDE」的直接链接">​</a></h4><p>KDE 是统计概率模型之一，统计概率模型是也是比较常见的异常检测思路。数据往往具有其分布规律，如果落在分布边界则触发了小概率事件，可能产生了异常。在正态中，99.73% 的数据分布在距平均值三个标准差以内（3-sigma）。如果我们的数据服从一定分布，就可以从分布曲线推断出现当前值的概率。</p><p><img loading="lazy" src="/zh-CN/assets/images/4-fa42b5dcef521da01fb4f52f8ad2779a.png" width="769" height="558" class="img_ev3q"></p><p>反映到变更监控场景中，变更前和变更后的时序数据服从一定分布（例如正态分布），那么变更后的当前时间点数据如果超过 N-sigma，则可以判断为异常，一个简要的检测可以描述为：</p><p><strong>step1：取变更前时间窗口内的N个数值作为样本M</strong></p><blockquote><p>针对变更前的异常数据点进行过滤，具体方法为：
剔除掉被定义为大于 99.5% 百分位数或小于 1% 百分位数的数值。</p></blockquote><p><strong>step2：计算样本的M的均值μ、标准差σ</strong></p><p><strong>step3: 当变更后时序时间点<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><msub><mi>X</mi><mi>i</mi></msub><mo>−</mo><mi>μ</mi><mi mathvariant="normal">∣</mi><mo>&gt;</mo><msub><mi>z</mi><mi>c</mi></msub><mo>∗</mo><mi>σ</mi></mrow><annotation encoding="application/x-tex">|X_i - μ| &gt; z_c * σ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">μ</span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6153em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.03588em">σ</span></span></span></span></span>时判断异常，其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">z_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span>为分布的分位数</strong></p><p>三个标准差 3-sigma 是常用的标准，但它的问题是，真实的变更时序数据大部分无法假设其真实分布，即使是一个小时间窗口里的数据分布也很复杂，它不是一个简单的正态分布。相比而言，KDE 是一种非参数估计方法，对数据分布不附加任何假定，只是从数据样本本身出发研究数据分布特征。</p><p>基于 KDE 的变更时序异常发现，主要流程同 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>−</mo><mi>s</mi><mi>i</mi><mi>g</mi><mi>m</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">N-sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em"></span><span class="mord mathnormal" style="margin-right:0.10903em">N</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">ma</span></span></span></span></span>，主要是 step2 不同，它需要重新构建变更前样本的数据分布:</p><p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mtext>，</mtext><msub><mi>x</mi><mn>2</mn></msub><mtext>，</mtext><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mtext>，</mtext><msub><mi>x</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">x_1，x_2，...，x_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord cjk_fallback">，</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord cjk_fallback">，</span><span class="mord">...</span><span class="mord cjk_fallback">，</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span>为独立同分布的 n 个样本点，设其概率密度函数为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span></span></span></span>，则核密度估计公式为：</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mi>f</mi><mo>^</mo></mover><mi>h</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>K</mi><mi>h</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mi>n</mi><mi>h</mi></mrow></mfrac><munderover><mo>∑</mo><mrow><mn>1</mn><mo>=</mo><mi>n</mi></mrow><mi>n</mi></munderover><mi>K</mi><mo stretchy="false">(</mo><mfrac><mrow><mi>x</mi><mo>−</mo><msub><mi>x</mi><mi>i</mi></msub></mrow><mi>h</mi></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\hat{f}_h(x)=\frac{1}{n}\sum_{i=1}^{n}K_h(x-x_i) = \frac{1}{nh}\sum_{1=n}^{n}K(\frac{x-x_i}{h})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2079em;vertical-align:-0.25em"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9579em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span><span style="top:-3.2634em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.0833em"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em"><span style="top:-1.8723em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.9185em;vertical-align:-1.2671em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">nh</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em"><span style="top:-1.8829em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mrel mtight">=</span><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.05em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.07153em">K</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2603em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">h</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></span></div><p>其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">h</span></span></span></span></span>为一个非负的平滑参数，称作带宽，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo stretchy="false">(</mo><mi mathvariant="normal">.</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">K(.)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.07153em">K</span><span class="mopen">(</span><span class="mord">.</span><span class="mclose">)</span></span></span></span></span>为核函数(非负、积分为 1，符合概率密度性质，并且均值为 0 )。核函数有很多种，例如：uniform , triangular , biweight , triweight , Epanechnikov , normal 等。依据变更前数据求得概率密度函数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span></span></span></span>后，即可求变更后任意点的概率，进行异常判断，若连续出现若干异常点，则可归类为异常点。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2监控异常检测之--特征统计">2、监控异常检测之 -「特征统计」<a href="#2监控异常检测之--特征统计" class="hash-link" aria-label="2、监控异常检测之 -「特征统计」的直接链接" title="2、监控异常检测之 -「特征统计」的直接链接">​</a></h4><p>传统的检测算法如k-sigma基于了正态分布的假设，不仅在短时序检测上会因为假设错误而影响检测准确率，在强周期的长时序上也难以识别出属于正常现象的周期上涨下跌。为此，我们采用短时序与长时序串联分析思路，短时序进行快速地异常发现，而长时序则进行周期性地校验分析，这能够使检测更加高效且鲁棒。同时我们也基于历史风险 Case 分析总结，沉淀了一套时序异常特征，用于特征统计计算。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="三operator架构重构升级">三、operator架构重构升级<a href="#三operator架构重构升级" class="hash-link" aria-label="三、operator架构重构升级的直接链接" title="三、operator架构重构升级的直接链接">​</a></h3><p>AlterShield-Operator 是一种在云原生场景下接入主端变更管控能力的实现。
它通过新增一种自定义资源—— ChangeDefense，以支持用户指定管控的 k8s 对象、变更过程中进行防御的时机，以及检测到风险后的行为。例如，在下图的示例中，指定对 default/test-app 这个 Deployment下的变更做管控，并且分别在25%，50%，75%的新版本 Pod 变更时，进行变更防御检测。</p><p><img loading="lazy" src="/zh-CN/assets/images/5-e37b39d9805454a304e8d562a6eaccaf.png" width="556" height="644" class="img_ev3q">
在指定上述的防御规则之后，当用户修改 test-app 相关定义时，Operator 会首先通过主端做变更前置校验。此外，在变更达到指定阶段后，Operator 会阻断变更，并通过主端进行变更防御校验，以识别过程中的风险。</p><p>目前，Operator由如下部分组成：
<img loading="lazy" src="/zh-CN/assets/images/6-03fed4f1528752a95266186a7fe13235.png" width="808" height="590" class="img_ev3q"></p><ol><li>WorkloadMutatingWebhook：一个 k8s mutating webhook。在接收到管控的工作负载的更新事件时，它会调用主端进行变更前置校验，并将相关的变更防御元数据记录在工作负载对象上。</li><li>ChangeDefenseController：自定义资源 ChangeDefense 的控制器。当管控的工作负载对象更新时，它也会调和关联的 ChangeDefense 对象。特别地，它会根据工作负载对象上记录的变更防御元数据，生成 ChangeDefenseExecution 对象。后者也是 Operator 新增的一种自定义资源，主要记录每次变更防御执行的数据，包括执行状态、变更对象（如 Pods）及防御结论等。</li><li>ChangeDefenseExecutionController：自定义资源 ChangeDefenseExecution 的控制器。它会实时地记录变更对象的信息，并且当变更执行到用户指定的阶段后（如上述示例的25%,50%...），触发主端执行变更防御服务。</li><li>PodValidatingWebhook：一个k8s validating webhook。在接收到 Pod 创建删除事件时，会根据变更防御执行状态进行拦截或放行，已控制变更节奏。</li><li>AlterShieldCallbackHandler：一个http server。它接收所有来自主端的防御执行结果回调，并根据执行结果更新变更防御执行状态</li><li>MetricsProvider：一个http server。它接收来自主端变更防御模块的请求，通过 Prometheus 或者 k8s metrics api 提供算法所需的时序指标数据。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四quick-start">四、Quick Start<a href="#四quick-start" class="hash-link" aria-label="四、Quick Start的直接链接" title="四、Quick Start的直接链接">​</a></h2><p>我们提供了一个详细的dev版本的Quick Start文档，如需了解更多可以前往AlterShield官网查看，地址：<a href="https://altershield.io/zh-CN/docs/quick-start/dev-quick-start%E3%80%82" target="_blank" rel="noopener noreferrer">https://altershield.io/zh-CN/docs/quick-start/dev-quick-start。</a></p><h1>03、未来展望</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一altershield主端">一、AlterShield主端<a href="#一altershield主端" class="hash-link" aria-label="一、AlterShield主端的直接链接" title="一、AlterShield主端的直接链接">​</a></h2><p>目前AlterShield主端已经提供一个完整可运行的版本。AlterShield作为一个中心化系统，同时服务于稳定性领域，这个系统的高可用要求非常之高。系统在设计之初考虑了很多稳定性的设计。比如系统降级入口、心跳机制、分库分表等等，这部分功能后续将持续的改造优化后开放，也欢迎大家参与进来一起共建。同时我们后续将开放更多的通用SRE专家经验沉淀的防御能力给大家，目前开放的altershield-framework-spi中定义了标准的扩展能力接口。也欢迎大家尝试编写自己的防御服务插件。</p><p>目前版本暂未提供可视化的UI操作界面，后续Dashboard也会列入下一个版本的计划中，同时也欢迎加入AlterShield社区一起共建。后续将补充简单易用的部署脚本以及部署教程到AlterShield官网。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二算法服务">二、算法服务<a href="#二算法服务" class="hash-link" aria-label="二、算法服务的直接链接" title="二、算法服务的直接链接">​</a></h2><p>由于对于开源算法能力改造投入有限，一期暂时仅支持短时序异常检测、长时序异常检测、KDE异常点分析、特征统计等能力，基于以上能力，能够很好的做到针对异常时序曲线的识别与拦截。但是，在实际业务生产中，仅仅关注召回率「风险拦截数/风险数」往往是不够的，如果我们针对每一笔变更都稳定拦截，召回率可达100%，并不能说明该算法的有效性。用户打扰率「拦截单数/变更单数」、准确率「有效拦截单数/拦截单数」也是评判算法能力的重要指标，而对于用户打扰率的降低和准确率的提升，我们必须要做的事情就是在保证拦截召回率的情况下，投入部分时间去做降噪处理。</p><p>针对于降噪的手段，我们预计会在后续的版本会提供以下能力：</p><ul><li>历史组特征分析&amp;短时序检测降噪方法</li><li>对照组异常波形比对降噪</li><li>多指标联合分析降噪手段</li></ul><p>虽然后续版本更多的会关注于降噪部分的逻辑，但是针对变更本身异常检测的能力的提升也是不可或缺的，同时在后续的版本中我们会提供一种基于影响面分析的多应用监控异常检测能力。</p><ul><li>上下游应用影响分析+监控盯盘</li></ul><p>最后，不管是业界还是蚂蚁集团内部，对于变更监控异常的检测，依旧存在一个未能有效解决的问题，那就是「小、无流量变更监控异常风险识别」问题，目前我们也针对该问题尝试搭建一套针对事前、事中、事后风险分析以及历史流量mock的手段去解决该问题，同时也希望能够集思广益，联合业界或开源社区有意共建的朋友们参与到该问题中，一起攻克这类风险识别难题，为稳定性领域添砖Java～</p><ul><li>挑战性：小无流量风险识别</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三altershield-operator">三、AlterShield Operator<a href="#三altershield-operator" class="hash-link" aria-label="三、AlterShield Operator的直接链接" title="三、AlterShield Operator的直接链接">​</a></h2><ul><li>更多的场景或管控对象：目前仅支持原生Workload，未来可以考虑支持更多的工作负载；或者不仅限于工作负载，比如Service、Ingress等4/7层网络配置场景。</li><li>插件化部署：将变更防御能力作为一种插件引入到ci/cd流程中，使智能变更管控覆盖更多使用场景。</li></ul>]]></content>
        <author>
            <name>Yalong Jin</name>
            <uri>https://github.com/jinyalong</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[「MeetUp」AlterShield x 同花顺]]></title>
        <id>https://traas-stack.github.io/zh-CN/blog/meetup-20230910</id>
        <link href="https://traas-stack.github.io/zh-CN/blog/meetup-20230910"/>
        <updated>2023-09-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[受同花顺稳定性负责人@杨征的邀请，蚂蚁集团AlterShield项目组的同学（王月凡、金亚龙）于9月15日下午1400与同花顺的SRE高可用领域的同学在同花顺总部做了一次线下交流。其中参与的同学有稳定性负责人、SRE、测试、质量、开发。]]></summary>
        <content type="html"><![CDATA[<blockquote><p>受同花顺稳定性负责人@杨征的邀请，蚂蚁集团AlterShield项目组的同学（王月凡、金亚龙）于9月15日下午14:00-16:00与同花顺的SRE高可用领域的同学在同花顺总部做了一次线下交流。其中参与的同学有稳定性负责人、SRE、测试、质量、开发。
<img loading="lazy" alt="img.png" src="/zh-CN/assets/images/1-e9fcc9cccd2f60ea24d61c6b1fe40641.png" width="1500" height="1125" class="img_ev3q"></p></blockquote><p>本次讨论主要涉及三个主要方面</p><ul><li>变更防控的价值</li><li>变更防控的方法和架构</li><li>变更防控的一些智能化实践</li></ul><p>本次交流主要针对下面问题展开了讨论，这里记录一些大家重点讨论的一些问题。</p><p><strong>1、系统召回率算法？是否区分制度管控的规则和系统识别出的风险。</strong></p><p>A：故障作为分母，拦截次数作为分子。会区分制度管控规则和系统识别的，召回率统计只关注系统识别的部分。</p><p><strong>2、实际落地中，防御能力准确性较高，效果较好的有哪些？</strong></p><p>A：新增突增异常，时序异常检测等</p><p><strong>3、变更场景复杂，多变。如何解决标准化问题？</strong></p><ul><li>配置变更</li><li>运营变更</li><li>运维变更</li></ul><p>A：OCMS SDK已经解决了标准化问题。</p><p><strong>4、风险识别建设比较宏观，难以发现业务代码层的问题，如何解决？</strong></p><p>A：通过程序分析手段，下钻到代码维度变更带来的影响。</p><p><strong>5、风险识别到改进的持续运营，是怎么做的？</strong></p><p>A：常态化运营，分析变更拦截case，变更故障case，故障的根因往往可以通过提供的防御框架将一些专家经验沉淀成防御规则。</p><p><strong>6、客户端发包的变更管控和服务端应用的变更管控都在一个平台实现吗？</strong></p><p>A：取决于客户端发包和服务端应用是否有运维变更平台。</p><p><strong>7、灰度计划和方案，在不同的业务场景下差异会比较大，平台侧是如何做管控的，到什么粒度？</strong></p><p>A：提供分批管控的策略，将变更的周期拉长有更多时间结合可观测手段去发现未知的风险。</p><p><strong>8、系统的管控接入，会影响整个devops流程的效率，如何平衡这个关系和推进系统接入？</strong></p><p>A：效率和风险一直是一个矛盾的话题，因公司业务、架构、背景而异。</p><p><strong>9、变更影响面评估是怎么实现的？变更影响面有哪些维度，输出的内容包含什么？</strong></p><p>A：一套完备的变更影响面模型，包括了程序分析的输出结果。通过trace分析代码、数据库、日志等之间的关系、链路。输出内容包括了影响的接口、表字段、日志等。</p><p><strong>10、如何管控方案设计侧的问题，走到最后变更的点是否已经晚了？</strong></p><p>A：设计阶段的问题较难管控。</p><p><strong>11、如何管控代码层面的问题（空指针，容错异常等）是否有左移的解决方案？</strong></p><p>A：可以通过一些自动化手段，在CI阶段扫描代码解决这些问题，程序分析技术。</p><p><strong>12、整个识别能力有没有和AI大模型结合的场景和案例？或者有无这块的规划和思路，可以做些讨论</strong></p><p>A：暂无。</p><p><strong>13、防御和识别能力的有没有制定标准？串联的哪些数字资产？</strong></p><p>A：防御框架的主要职责就是制定了防御的标准。串联了不同系统之间的程序代码、数据库、消息、接口之间的血缘关系。</p><p><strong>14、系统定义的风险业务方是否认可，业务如何自定义自身的规则？</strong></p><p>A：提供一套可扩展的SPI，有通用的规则，也有不同业务方针对自己系统的自定义规则。</p><p><strong>15、后置检测的能力如何深入到业务指标？</strong></p><p>A：结合可观测手段。</p><p><strong>16、测试平台和变更管控的边界如何界定？比如是否完成压测，单元测试覆盖率，这些是管控在变更侧还是测试平台？</strong></p><p>A：CI阶段应该发现这些问题并卡点，而不是等到变更阶段。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>同花顺是一家典型的金融企业，主要经营基金、股票和证券交易业务，风险容忍度极低。最近一次变更故障导致了严重的后果，希望通过一些系统化的方法来降低变更引发风险的可能。
在与同花顺的沟通中，我们了解到他们更关注风险的左移，即希望在变更之前做更多的准备工作。由于业务的特殊性，比如周末休市业务量较小和业务代码错误bug难以发现等问题，同花顺特别注重稳定性。他们将1018这一特殊的日期视为稳定性的重要日子，类似于蚂蚁公司的1218，这表明他们非常重视变更引发的问题。我们将继续与同花顺保持沟通和交流，确保能进行一些更多开源社区的互动与交流。</p>]]></content>
        <author>
            <name>Yuefan Wang</name>
            <uri>https://github.com/yvan-wyf</uri>
        </author>
        <author>
            <name>Yalong Jin</name>
            <uri>https://github.com/jinyalong</uri>
        </author>
        <category label="MeetUp" term="MeetUp"/>
        <category label="AlterShield" term="AlterShield"/>
        <category label="蚂蚁集团" term="蚂蚁集团"/>
        <category label="同花顺" term="同花顺"/>
        <category label="变更管控" term="变更管控"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[「MeetUp」AlterShield x 美团 x 作业帮 x OPPO]]></title>
        <id>https://traas-stack.github.io/zh-CN/blog/meetup-20230710</id>
        <link href="https://traas-stack.github.io/zh-CN/blog/meetup-20230710"/>
        <updated>2023-07-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[在第一次[线下MeetUp]举行之后，发现大家对于变更管控技术的兴趣还是比较浓厚的。同时有几个公司的小伙伴找到我们，希望再组织一次这样的交流。]]></summary>
        <content type="html"><![CDATA[<p>在第一次<a href="https://altershield.io/zh-CN/blog/meetup-0618/" target="_blank" rel="noopener noreferrer">线下MeetUp</a>举行之后，发现大家对于变更管控技术的兴趣还是比较浓厚的。同时有几个公司的小伙伴找到我们，希望再组织一次这样的交流。
于是我们在<strong>7月10日 14:00-16:00</strong>通过线上腾讯会议的方式再一次组织起从事SRE相关工作的一些同学参与到一起来讨论。在整个交流过程中，大家问到的一些
问题都是曾经变更管控在蚂蚁集团落地变更管控遇到的一些困难和问题，在这里整理分享给大家。</p><blockquote><p>本次腾讯会议参加的同学主要有来自蚂蚁集团、美团、OPPO、作业帮的同学
会议峰值人数达到30人
<img loading="lazy" alt="img.png" src="/zh-CN/assets/images/1-efdc8b9b99abea885f8252dc01b6e106.png" width="3528" height="2232" class="img_ev3q"></p></blockquote><p><strong>本次线上MeetUp进程主要如下：</strong></p><p>1、王月凡同学分享了关于变更防控三个主要的点：</p><ul><li>变更防控的价值</li><li>变更防控的方法和架构</li><li>变更防控的实践</li></ul><p>在分享完之后大家展开了比较激烈的讨论，线上提问超<strong>30个</strong>，这里整理一些比较有代表性的问题同大家分享交流。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1变更防控的价值">1、变更防控的价值<a href="#1变更防控的价值" class="hash-link" aria-label="1、变更防控的价值的直接链接" title="1、变更防控的价值的直接链接">​</a></h2><p><img loading="lazy" alt="img.png" src="/zh-CN/assets/images/2-8b24a870e6a5a66cb7e00ff2863b3185.png" width="1027" height="590" class="img_ev3q"></p><p>当前互联网、科技技术公司面临的变更风险挑战：</p><ol><li>相互交错的组织协同模式</li><li>错综复杂的分布式微服务链路</li><li>对于稳定性问题的容忍度</li></ol><p>如何应对公司错综复杂的变更操作，做好变更防控，降低变更引入的稳定性风险，主要聚焦变更技术架构、标准与规范、以及智能化技术的应用，通过技术的手段保障变更效率的同时，降低变更风险。
如何从公司视角，保持大家的步调一致，从而避免不必要的风险。这些问题都是典型的行业难题，这也是变更管控的价值所在。</p><p>更多信息获取见：<a href="https://altershield.io/zh-CN/blog/welcome-altershield-v0.1/" target="_blank" rel="noopener noreferrer">AlterShield v0.1正式开源</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2变更防控方法与架构">2、变更防控方法与架构<a href="#2变更防控方法与架构" class="hash-link" aria-label="2、变更防控方法与架构的直接链接" title="2、变更防控方法与架构的直接链接">​</a></h2><p>要把变更防控起来，最重要的第一件事就是先定义清楚什么是变更，我们对变更的广泛定义是：<strong><em>"企业内部人员触发的任何导致IT服务状态发生变化的行为"</em></strong></p><p>同时我们定义了一套标准的开放式变更管控协议<strong><a href="https://altershield.io/zh-CN/docs/open-change-management-specification/overview" target="_blank" rel="noopener noreferrer">OCMS</a></strong>，该协议已经在蚂蚁集团内部接入了上千种变更场景，并且有效拦截了数百次可能引发故障的变更风险。</p><p>但是接入变更管控并不意味着能够完全消除变更带来的风险，而是有更多技术性手段可以降低风险。
<img loading="lazy" alt="img.png" src="/zh-CN/assets/images/3-44b0bae9cc8e3362d26eadf33aafffab.png" width="959" height="420" class="img_ev3q"></p><p>我们提出了<strong>变更的三板斧</strong>：可灰度（避免一次性梭哈变更）、可观测（变更过程中有可观测的指标、监控...）、可应急（变更出现问题有快速回滚的能力）</p><p>通过对变更灰度分批次执行与管控，每个批次的执行都需要回答以下三个问题：</p><ol><li>能不能做？ </li><li>做没做完？ </li><li>做没做对？ </li></ol><p>总的来说，通过对变更的灰度、分批次执行，并在每一个批次都进行前后置的风险校验，理论上来说一次变更的风险是逐渐被收敛的，一次变更的风险变化趋势图如下：</p><p><img loading="lazy" alt="img.png" src="/zh-CN/assets/images/4-09b338fc90af5c4bd542299518bdb98d.png" width="819" height="443" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3变更防控智能化实践">3、变更防控智能化实践<a href="#3变更防控智能化实践" class="hash-link" aria-label="3、变更防控智能化实践的直接链接" title="3、变更防控智能化实践的直接链接">​</a></h2><p>随着业务的快速发展，各种业务系统都在走向平台化，运维方式在经历人肉运维，脚本自动化运维后最终演变成<strong>DevOps</strong>。但随着大数据及人工智能的快速发展，传统的运维方式及解决方案已不能满足需求。
基于如何提升平台效率和稳定性及降低资源，关于蚂蚁集团内部一些<strong>AIOps</strong>的实践及实现分享给大家。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="case-1指标的实时时序异常检测">case 1：指标的实时时序异常检测<a href="#case-1指标的实时时序异常检测" class="hash-link" aria-label="case 1：指标的实时时序异常检测的直接链接" title="case 1：指标的实时时序异常检测的直接链接">​</a></h3><p><img loading="lazy" alt="img.png" src="/zh-CN/assets/images/5-cf2f317de4f5b25aad2f1639a91726d3.png" width="1003" height="587" class="img_ev3q"></p><p>这里实现的思路主要是结合监控平台对不同分组的机器的各种指标的时序序列使用一些智能化算法进行异常检测。 这里对一次变更的机器定义了如下组别：</p><ul><li>变更组：一个应用正在变更批次机器的时序</li><li>历史组：该应用的同一个变更动作的同一个指标的历史时序</li><li>背景组：该应用变更批次机器较长时间窗口内的时序</li><li>对照组：该应用尚未发生变更批次机器的同时刻的时序</li><li>日志组：该应用正在变更批次机器的 common error 日志信息</li></ul><p>实践发现，如果不进行降噪，通常会有较大的噪声导致拦截率较高，影响业务。因此降噪也是很重要的一部分，主要的降噪维度有：</p><ul><li>时间角度</li><li>变更对象</li><li>变更范围</li><li>历史相似度</li></ul><p>相关算法技术：</p><ul><li>DTW（ Dynamic Time Warping ，动态时间规划)</li><li>3-Sigma</li><li>KDE(Kernel Density Estimation，核密度函数估计) </li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="case2日志堆栈新增突增异常检测">case2：日志堆栈新增/突增异常检测<a href="#case2日志堆栈新增突增异常检测" class="hash-link" aria-label="case2：日志堆栈新增/突增异常检测的直接链接" title="case2：日志堆栈新增/突增异常检测的直接链接">​</a></h3><p><img loading="lazy" alt="img.png" src="/zh-CN/assets/images/7-45f094d16a9613f6cb7fdb8e241c6479.png" width="417" height="384" class="img_ev3q"></p><p>异常检测维度:</p><ul><li>新增异常日志类型： 对比变更前后，系统堆栈日志是否有出现过新的日志模板类型</li><li>突增异常日志类型： 对比变更前后，系统堆栈日志是否有某个日志模板类型，日志量有较大的增长</li></ul><p><em>ps:关于更多智能化变更异常检测算法，近期将在<a href="https://altershield.io" target="_blank" rel="noopener noreferrer">AlterShield官网</a>进行开源</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="meetup问题讨论-整理">MeetUp问题讨论 整理<a href="#meetup问题讨论-整理" class="hash-link" aria-label="MeetUp问题讨论 整理的直接链接" title="MeetUp问题讨论 整理的直接链接">​</a></h2><p>这里整理了一些比较好的问题，关于大家更多的问题咨询见：<a href="https://altershield.yuque.com/org-wiki-altershield-gug9gu/lg0rts/clg87wxx0gbypfg4" target="_blank" rel="noopener noreferrer">MeetUp回放</a></p><p><strong>1、变更管控的效果和价值评价？</strong></p><p>主要是靠防御有效拦截率来证明，有效性主要通过看业务是否有真实的回滚，以及对业务是否有影响。</p><p><strong>2、变更前后置涉及到的交互会影响一大片变更平台，作为中心化系统的鲁棒性设计。</strong></p><p>SDK中要考虑这种容错性设计，首先对于管控系统的技术要求会较高，其次SDK中通过心跳机制实时的检测管控端是否出现问题，当出现问题时执行一些降级策略，确保变更平台不会因为管控平台的故障导致连带的故障。</p><p><strong>3、是否一定要按照<a href="https://altershield.io/zh-CN/docs/open-change-management-specification/overview" target="_blank" rel="noopener noreferrer">OCMS</a>协议，不同场景填写信息不太一样？</strong></p><p><a href="https://altershield.io/zh-CN/docs/open-change-management-specification/overview" target="_blank" rel="noopener noreferrer">OCMS</a>协议是我们基于蚂蚁集团内部五年落地变更管控的经验，总结提炼的一套普适性较强的变更信息模型，对于不同场景填写的信息是不完全一样的。这套协议是可以根据自己的业务场景进行调整修改的～</p><p><strong>4、接入变更管控就能完全避免变更的风险吗？</strong></p><p>能很大程度上降低变更所引入的风险，变更的执行和管控分离是一种降低变更风险的思路，通过灰度、分批校验等技术手段尽可能的暴露出一次变更的风险并收敛。
同时当真的出现变更引起的问题时，具备有效的手段快速的建设能力（防御规则）避免下次同类问题的再次出现。</p><p><strong>5、关于智能分析的一些疑问？</strong></p><p>变更智能分析是下沉到代码维度的分析，程序分析本身就是一个比较有技术深度的问题，在蚂蚁集团内部是有独立的团队研究，此部分内容后续将通过一些文章简单介绍～</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="加入我们">加入我们<a href="#加入我们" class="hash-link" aria-label="加入我们的直接链接" title="加入我们的直接链接">​</a></h2><p>开源项目官网：<a href="https://altershield.io" target="_blank" rel="noopener noreferrer">AlterShield官网</a>, <a href="https://github.com/traas-stack/altershield" target="_blank" rel="noopener noreferrer">Github仓库地址</a></p><p>欢迎大家加入AlterShield开源项目群参与讨论：</p><p><img loading="lazy" alt="img.png" src="/zh-CN/assets/images/8-189fc2ed1d3521fc7a98e7c2a76f8a51.png" width="986" height="1280" class="img_ev3q"></p>]]></content>
        <author>
            <name>Yuefan Wang</name>
            <uri>https://github.com/yvan-wyf</uri>
        </author>
        <author>
            <name>Yalong Jin</name>
            <uri>https://github.com/jinyalong</uri>
        </author>
        <author>
            <name>Haouan Yu</name>
            <uri>https://github.com/yhaoxuan</uri>
        </author>
        <category label="MeetUp" term="MeetUp"/>
        <category label="AlterShield" term="AlterShield"/>
        <category label="蚂蚁集团" term="蚂蚁集团"/>
        <category label="OPPO" term="OPPO"/>
        <category label="作业帮" term="作业帮"/>
        <category label="美团" term="美团"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[「MeetUp」AlterShield x bilibili x 联通软件研究院]]></title>
        <id>https://traas-stack.github.io/zh-CN/blog/meetup-20230618</id>
        <link href="https://traas-stack.github.io/zh-CN/blog/meetup-20230618"/>
        <updated>2023-06-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[联通软件研究院，bilibili，蚂蚁集团的从事变更相关的同学在杭州首次线下的MeetUp，本次线下交流的都是在SRE领域有着丰富经验的同学，都在各自的公司参与了SRE关键工作和平台的建设，大家对于SRE如何做好变更的风险防控，以及中间可能会遇到的问题进行了讨论和交流，下面整理了一些讨论交流的内容，分享给大家。]]></summary>
        <content type="html"><![CDATA[<p>联通软件研究院，bilibili，蚂蚁集团的从事变更相关的同学在杭州首次线下的MeetUp，本次线下交流的都是在SRE领域有着丰富经验的同学，都在各自的公司参与了SRE关键工作和平台的建设，大家对于SRE如何做好变更的风险防控，以及中间可能会遇到的问题进行了讨论和交流，下面整理了一些讨论交流的内容，分享给大家。</p><blockquote><p>本次是AlterShield开源后的第一次线下交流MeetUp，刚好有几位小伙伴对变更管控有兴趣，同时也在杭州，故一拍即合组了一个线下关于变更管控的技术讨论交流。<br>
<!-- -->地点：杭州·市民中心附近星巴克<br>
<!-- -->时间：2023.06.18<br>
<!-- -->本次MeetUp参与人(照片左至右)：
<img loading="lazy" src="/zh-CN/assets/images/1-533826f82e75550013089319cc69a2b4.png" width="1416" height="1062" class="img_ev3q"></p><ul><li>吴天昊（联通软件研究院 副总架构师)</li><li>邵创创（联通软件研究院 变更管理负责人）</li><li>刘昊（Bilibili SRE体系&amp;平台工程负责人）</li><li>王月凡（蚂蚁集团 AiOps&amp;变更管控负责人）</li><li>袁帅（Bilibili 运维数据资产负责人）</li></ul></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-变更管控的重要性">1. 变更管控的重要性<a href="#1-变更管控的重要性" class="hash-link" aria-label="1. 变更管控的重要性的直接链接" title="1. 变更管控的重要性的直接链接">​</a></h2><p>线下交流的时候，大家都非常认可对于一个技术企业稳定性来说，变更管控是非常关键且重要的一件事情，在变更引发的故障上，都有相同的惨痛经历，同时变更又是一家技术公司往前演进的步伐，不能纯靠一些流程管控的手段，去加重变更的负担和周期，需要依靠一些技术手段，对变更风险进行有效的防控与处置，能够统一从SRE的角度，合理有效的去控制不同业务场景，可能引发的变更风险，同时对不同的业务场景，配置上通用的、定制化的防御防线，在变更期间去阻断变更引发的风险。</p><p>让<strong>变更做到三板斧：可灰度、可观测、可回滚</strong>，是能够防控变更风险的的关键思路，也是变更管控平台技术体系的基础支撑，<strong>让变更执行能够灰度分批的生效，同时系统自动盯盘，进行前后置校验，当算法识别到风险后，阻断变更的执行，有效防止风险扩大</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-关于如何快速进行变更管控的接入">2. 关于如何快速进行变更管控的接入？<a href="#2-关于如何快速进行变更管控的接入" class="hash-link" aria-label="2. 关于如何快速进行变更管控的接入？的直接链接" title="2. 关于如何快速进行变更管控的接入？的直接链接">​</a></h2><p>公司里面都有无数的变更执行平台，无论是负责服务器发布、运维的平台，还是底层网络、基础设施的变更平台，还是业务上的运营配置变更的平台，这些变更执行平台，都需要进行改造，接入到变更管控的标准体系内，但是在公司内部，这些变更平台负责人，本身是少有稳定性目标的，同时在故障真正发生之前，不太会重视变更可能会引发的稳定性风险，理所当然在变更管控接入改造配合度上，意愿度也不会特别强。</p><p>关于如何快速推进变更管控的接入，大致上有<strong>三个思路</strong>：</p><p><strong>1. 先从故障/风险较高的平台入手，以全站通用防控能力作为切入，如封网、窗口等，从而快速达到管控效果</strong>  </p><p><strong>2. 及时借力故障发生时，故障往往发生后，风险意识、整改动力是比较强的</strong> </p><p><strong>3. 不断的宣贯变更的风险及其重要性。</strong> </p><p>除上述方式外，还是得持续探索底层无须改造接入的变更防控方案，比如从流量网关层、SQL执行层等。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-如何衡量变更风险防控的效果">3. 如何衡量变更风险防控的效果<a href="#3-如何衡量变更风险防控的效果" class="hash-link" aria-label="3. 如何衡量变更风险防控的效果的直接链接" title="3. 如何衡量变更风险防控的效果的直接链接">​</a></h2><p>前期可以通过<strong>变更防御有效识别和拦截的风险数据</strong>，去衡量变更风险防控带来的效果，这个前提是需要提前做好变更影响面分析、变更防御能力，能够针对每一笔变更，分析出有效的影响面，包括不限于影响的上下游系统、业务链路等，以及应该观测的监控指标，同时在结合变更防御自动的算法异常检测，能够实时的在变更期间识别指标异动、日志异常，有效的阻断变更风险。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-系统自动防御盯盘-vs-人工盯盘">4. 系统自动防御盯盘 VS 人工盯盘<a href="#4-系统自动防御盯盘-vs-人工盯盘" class="hash-link" aria-label="4. 系统自动防御盯盘 VS 人工盯盘的直接链接" title="4. 系统自动防御盯盘 VS 人工盯盘的直接链接">​</a></h2><p>在变更执行期间去往往需要运维同学人工进行盯盘，观察监控、观察日志，而人工观察天然会存在遗漏，并且人的精力是无法同时观察成百上千个系统指标，更何况往微服务分布式方向演进，一个系统的变更，往往涉及到上下游众多链路，仅靠人工是无法去完整观测齐全的，同时人工的观测非常依赖历史经验积累，往往不同经验的人工进行盯盘，效果差异都会比较大。
依赖系统进行自动的防御盯盘，就如同自动驾驶技术的视觉感知系统一样，<strong>系统对于指标进行实时的算法异常检测，高效的同时对成百上千的系统指标、业务指标进行全自动的监控指标盯盘，快速有效的识别指标异动，同时在结合上变更管控的能力，能够有效的阻断、防控变更风险，防止变更风险逐步扩大</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-为什么一定要变更管控与变更执行平台分离">5. 为什么一定要变更管控与变更执行平台分离？<a href="#5-为什么一定要变更管控与变更执行平台分离" class="hash-link" aria-label="5. 为什么一定要变更管控与变更执行平台分离？的直接链接" title="5. 为什么一定要变更管控与变更执行平台分离？的直接链接">​</a></h2><p>更专业的人，做更专业的事情，往往变更执行平台，考虑的问题是如果设计变更流程，尽可能快速执行完成，尽快自动化，但变更对于稳定性的影响，这个是一个持续性的防控问题，不会在变更平台设计之初，就完全解决掉，而SRE往往是对稳定性最终负责的人，所以是很有必要将变更管控单独提炼出来，这部分的持续演进和设计理念，主要都是围绕如何让SRE更加灵活、高效的防控风险故障去设计的，所以对应变更管控平台的开放性要求会高一些。</p><p>最终在<strong>变更管控平台设计的思路上，会选择以切面的方式，将两部分平台职责划分开，让更专业的人，更专注的去做风险防控的事情，同时也便于做整个公司级统一的封网、窗口、规范性的管控和要求</strong>。 </p><p>如下图所示：
<img loading="lazy" src="/zh-CN/assets/images/2-425108a37cc1fd8b781cafcec2187265.png" width="1500" height="1103" class="img_ev3q"></p><p>本次交流了不少最近大家行业里面的趣事、八卦，还有对于整个SRE领域发展的看法和期待，整个过程非常的轻松自在，也非常期待后续有更多有想交流讨论的同学，再组一次分享与交流（不限聊技术~hahaha）</p><center>⭐️⭐️看这里⭐️⭐️欢迎微信扫码进交流群，期待与您的下一次MeetUp！</center><center>预约参加下一次MeetUp加微信：yvan_wyf</center><p><img loading="lazy" src="/zh-CN/assets/images/3-9ad0a48f215a2d5b25165b0be9590bc1.png" width="986" height="1280" class="img_ev3q"></p>]]></content>
        <author>
            <name>Yuefan Wang</name>
            <uri>https://github.com/yvan-wyf</uri>
        </author>
        <author>
            <name>Yalong Jin</name>
            <uri>https://github.com/jinyalong</uri>
        </author>
        <category label="MeetUp" term="MeetUp"/>
        <category label="AlterShield" term="AlterShield"/>
        <category label="蚂蚁集团" term="蚂蚁集团"/>
        <category label="Bilibili" term="Bilibili"/>
        <category label="联通软件研究院" term="联通软件研究院"/>
        <category label="SRE" term="SRE"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[AlterShield 正式开源]]></title>
        <id>https://traas-stack.github.io/zh-CN/blog/altershield-v0.1</id>
        <link href="https://traas-stack.github.io/zh-CN/blog/altershield-v0.1"/>
        <updated>2023-06-09T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[AlterShield 的出现，旨在通过系统化的方式解决SRE领域变更引发的稳定性风险问题，变更管控领域相关的问题。]]></summary>
        <content type="html"><![CDATA[<p>AlterShield 的出现，旨在通过系统化的方式解决SRE领域变更引发的稳定性风险问题，变更管控领域相关的问题。</p><h1>AlterShield 简介</h1><p>AlterShield 的出现，旨在通过系统化的方式解决SRE领域变更引发的稳定性风险问题，变更管控领域相关的问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="什么是变更管控">什么是变更管控？<a href="#什么是变更管控" class="hash-link" aria-label="什么是变更管控？的直接链接" title="什么是变更管控？的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="变更问题的价值和意义">变更问题的价值和意义<a href="#变更问题的价值和意义" class="hash-link" aria-label="变更问题的价值和意义的直接链接" title="变更问题的价值和意义的直接链接">​</a></h3><p>对于生产环境的稳定性，是各个互联网行业相关公司都关注的。尤其是对于大型互联网公司来说，稳定性就显得更为重要。另外，从诱发稳定性问题的原因分析来说，变更及编码问题所占据的比例，常年超过一半以上。历史上因此产生的重大故障不胜枚举。</p><p><img loading="lazy" src="/zh-CN/assets/images/1-81885effe5a276b58c45f727dc908a87.png" width="850" height="344" class="img_ev3q"></p><p>同时，由于分布式所带来的系统复杂度、业务越来越复杂所带来组织间关系的复杂度。导致了像亚马逊、NetFlix、蚂蚁集团这类业务体系庞大的公司，变更的问题就更为严重。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="变更管控的思路">变更管控的思路<a href="#变更管控的思路" class="hash-link" aria-label="变更管控的思路的直接链接" title="变更管控的思路的直接链接">​</a></h3><p>虽然说业界有了上述的一个共识，但诱发线上问题的根因是多种多样的，比如编码引入的Bug、变更人员的疏忽、人员之间沟通不到位等等。同时，随着业务体量的不断增大，组织划分与团队协作关系也会日益复杂。这种关系是符合康威定律的，也就是说组织关系的复杂会引发沟通成本的加剧，也间接导致了变更问题难以管控。</p><p><img loading="lazy" src="/zh-CN/assets/images/2-f27b9e8892864fea162bbc39cba3abf6.png" width="845" height="267" class="img_ev3q"></p><p>所以，对于变更管控的思路，业界最基础也最容易实现的方案是做事件的感知 + 计划报备审批。但这种方式的弊端在于强依赖审批者的专家经验，且无法扩大变更管控的规模。</p><p>我们在蚂蚁集团实践的变更管控思路是：<strong>在整个变更的生命周期中（包括变更事前的计划报备、提前的变更风险及影响分析、变更中的异常观测、变更出现异常的熔断及自愈、变更完成后的变更度量及审计），以系统化的手段去防控和管理约束变更流程，使变更流程实现“三板斧”：可灰度、可观测、可应急</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="那么altershield-是什么">那么，AlterShield 是什么？<a href="#那么altershield-是什么" class="hash-link" aria-label="那么，AlterShield 是什么？的直接链接" title="那么，AlterShield 是什么？的直接链接">​</a></h2><p><strong>AlterShield 是作为变更管控领域中一款集变更感知、变更防御、变更分析于一身的一站式管控平台。旨在通过定义变更标准协议，规范变更管控流程，使得用户可以快速发现变更中的问题，并及时降低故障影响面。</strong></p><p>AlterShield 是蚂蚁集团内部研发了近 5 年的变更管控平台 OpsCloud 的开源版本。经过多年大型互联网公司内部复杂业务场景的驱动，OpsCloud 在变更管控领域沉淀了丰富经验，是蚂蚁集团内部全部类型变更的统一管控平台，也是业务研发、质量测试、SRE同学日常进行变更感知、变更分析、变更异常识别的重要入口，在蚂蚁集团的变更风险防控上取得了显著的效果。我们非常希望能将这些经验和业界进行共同探讨与共同演进，为此我们开源了 AlterShield，因为整套变更防控系统较复杂，我们会逐步将所有的功能共享到社区，也非常欢迎大家来和我们交流关于你当前遇到的关于这个领域遇到的问题。</p><h1>AlterShield 整体技术架构</h1><p><img loading="lazy" src="/zh-CN/assets/images/3-2d04d4dab1f8a709d644e46534e20fd4.png" width="1500" height="788" class="img_ev3q"></p><p>在技术架构上，AlterShield 分为以下几部分内容：</p><ol><li>产品功能层：面向研发、质量、SRE同学，提供变更信息感知及订阅、变更信息搜索、变更分析结果查看、变更计划执行流程、变更防御配置、变更防御异常检测结果感知的产品能力。</li><li>OCMS（Open Change Management Specification） SDK，我们想逐步构建一套标准的变更信息协议，未来在这个领域，大家都能够基于一套标准的协议，去进行各自的系统设计；目前的协议是基于蚂蚁集团的上千种变更场景总结归纳而来，非常初期的一个版本，这部分也欢迎大家来一起演进，协议包含两部分内容：
a. 变更信息协议：这个信息协议是上层变更平台与后续所有功能模块间进行变更信息交互的标准信息结构。
b. 变更技术协议：一种按代际区分不同变更生效流程的SDK，所有上游变更平台通过该方式对接 AlterShield 进行前后置切面的管控。</li><li>Analyser Framework（变更分析框架）：在OCMS SDK流程中，提供了变更前的影响面分析、风险分析、可观测性分析能力，会对变更内容、变更影响面、变更执行策略进行分析，同时基于这些分析结果，给出本次变更的风险分级，能够描述这个变更可能存在的危险程度。</li><li>Defender Framework（变更防御框架）：在OCMS SDK流程中，提供了变更中异常识别手段的路由、调度、并发执行、异步化控制能力，最终给出变更是否准入或可继续的判定。</li><li>Defender Service（变更防御服务）：AlterShield 在防御框架中集成的全局通用的防御能力。如：可观测性领域的异常检测、配置变更中配置值的自适应校验、变更窗口及封网的管控、定制模板的变更参数校验。</li><li>开放扩展：以Plugin、SPI的形式，集成不同领域对于变更分析、变更防御的不同诉求，并以配置化的形式进行路由、执行，能够更加灵活的满足不同变更场景、不同业务场景下的风险防控诉求。</li><li>事件调度：AlterShield 中各个模块间的交互方式都是通过内部事件来进行的，同时也负责各防御能力、分析能力的并发调度执行。</li></ol><p>上面介绍到的模块，我们都会陆续在Github仓库开源，也欢迎大家一起来参与，接下来，我们将结合 AlterShield 中几个关键模块，来详细介绍下我们的变更管控思路。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="什么是变更">什么是变更？<a href="#什么是变更" class="hash-link" aria-label="什么是变更？的直接链接" title="什么是变更？的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="变更的概念">变更的概念<a href="#变更的概念" class="hash-link" aria-label="变更的概念的直接链接" title="变更的概念的直接链接">​</a></h3><p>在做变更之前，我们必须先弄清楚，什么是“变更”，或者说什么是我们稳定性领域所关心的“变更”？业界通常把“Ops”当做变更，但“Ops”更多指的是研发、运维人员做的偏运维动作。在变更管控领域，“变更”这个概念要比“Ops”在范围上大很多。</p><p>所以，我们最开始对变更的定义是：<strong>任何导致线上服务状态发生变化的行为叫做变更</strong>。</p><p>然而这样的定义过于模糊。比如“状态”这个概念，如果说服务依赖和包含的持久化数据是一种显而易见的状态，那么服务当前所处的、时时流逝着的时钟是否算作“状态”？再比如数据显而易见是“状态”，那么如果用户打开支付宝发起一笔转账，这个行为是否属于“对账务系统的记账表数据状态做了变化”从而应该视作变更？</p><p>带着这个问题，我们分析了历史上由变更引发的线上环境故障案例。发现一个共性：它们都是企业内部人员通过某个平台或黑屏命令进行的线上操作。这些内部人员从运维、研发、产品到活动运营等，涵盖了多种角色。于是，变更，或者说做变更管控所需要关心的变更，指的就是“<strong>内部人员触发的任何导致线上服务状态发生变化的行为</strong>”。因此Linux时钟滴答不是变更，用户转账也不是。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="变更标准化协议ocms-open-change-management-specification">变更标准化协议（OCMS-Open Change Management Specification）<a href="#变更标准化协议ocms-open-change-management-specification" class="hash-link" aria-label="变更标准化协议（OCMS-Open Change Management Specification）的直接链接" title="变更标准化协议（OCMS-Open Change Management Specification）的直接链接">​</a></h3><p>在圈定了我们的目标范围之后，另一个要解决的问题是：单一系统发起的变更，其影响范围并不局限于这个系统本身，这对于研发、运维人员的经验性带来了极高的要求与分析成本。同时，每个企业所处的业务背景不同，甚至同一家企业不同的业务部门之间也存在着较大的差异与壁障。这个问题导致各个企业或部门所做的变更在语义、描述方式和生效方式等方面有着巨大的差异。</p><p>举个简单的例子：对于传统运维变更、业务运营配置这两类变更来说，在公司内部承载的平台可能是两个，且由不同的业务线团队来负责。那么这种差异就会导致这两类变更对于信息的定义（比如变更的内容、对象）、变更的生效模式（运维变更可能是按照服务器维度生效，业务运营配置更多是DB/内存/缓存中的数据修改）、变更的影响范围等都有所不同。那么想要对这两类变更同时在一个平台上进行管控，不统一这种信息及技术差异，成本是极高的。</p><p>针对于上述复杂场景，AlterShield 定义了OCMS（Open Change Management Specification）SDK，其中包含两部分内容：变更信息协议、变更技术协议。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="变更信息协议">变更信息协议<a href="#变更信息协议" class="hash-link" aria-label="变更信息协议的直接链接" title="变更信息协议的直接链接">​</a></h4><p>因此，AlterShield 在进行变更管控的第一步前提就是要做到不同背景下的变更信息及技术统一，其信息协议的定义可以参考下图：</p><p><img loading="lazy" src="/zh-CN/assets/images/4-c2e2f5934b59eb5a80f2022cd5005100.png" width="1039" height="632" class="img_ev3q">
这样信息协议标准化的好处是：</p><ol><li>可以兼容不同背景下的各类变更，实现了多类型变更的“统一管控”</li><li>屏蔽了上层业务场景带来的信息差异，使得变更管控后续的变更防御、变更搜索、变更审计可以基于一套标准的信息模型来进行</li><li>为其他技术风险领域相关的能力（如应急定位等）的结合提供了一套统一的信息模型，能够帮助业务在发生问题时快速定位到相关业务链路所发生过的变更</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="变更技术协议">变更技术协议<a href="#变更技术协议" class="hash-link" aria-label="变更技术协议的直接链接" title="变更技术协议的直接链接">​</a></h4><p>在信息协议标准化处理之后，另一个问题就是上文例子中提到的“传统运维变更和业务运营配置变更，其变更生效模式不同”。这种流程上的不同，会导致变更在做管控时交互的机制不同。</p><p>再举个简单的例子：对于传统运维变更，通常是按照服务器分批生效的。那么对于这个变更单来说，变更管控平台可以在每个批次的前后做管控校验和信息收集；但对于DB配置类运营变更，由于DB数据仅有一份生效，所以在生产环境中的变更通常只有一个步骤，或者在上层通过UID控制分批生效。</p><p>因此，针对上述的变更流程和生效方式的不同。AlterShield 在技术协议上，通过前后置切面的形式，定义了“变更代际”的概念，从G0~G4共分为5个代际（G取自英文单词中Generation）：</p><table><thead><tr><th>代际名称</th><th>支持的变更流程和生效方式</th></tr></thead><tbody><tr><td>G0</td><td>以事件通知的协议接入 AlterShield，不提供管控能力，仅可做变更事件的通知、搜索</td></tr><tr><td>G1</td><td>对于无法按照批次拆分一步一步生效的变更，做单节点的变更流程管控</td></tr><tr><td>G2</td><td>可以按照批次拆分生效的变更（如集群服务器重启），做完整工单的变更流程管控</td></tr><tr><td>G3</td><td>在有完整的变更工单管控的基础上，增加了变更提单阶段的管控</td></tr><tr><td>G4</td><td>在变更提单管控的基础上，增加了变更无人值守的决策能力</td></tr></tbody></table><p>这种技术协议标准带来的好处是：<strong>平台业务团队与风险防控团队有了明确的职责划分边界，以及一个统一交互的标准方式，变更平台研发的团队，更聚焦于平台研发本身，而SRE团队可以关注于变更的风险防控与治理，让更专业的人做更专业的事情。</strong></p><p><img loading="lazy" src="/zh-CN/assets/images/5-43c95c8a5482d90797be99da55c362d1.png" width="967" height="927" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="云原生下的-ocms-集成">云原生下的 OCMS 集成<a href="#云原生下的-ocms-集成" class="hash-link" aria-label="云原生下的 OCMS 集成的直接链接" title="云原生下的 OCMS 集成的直接链接">​</a></h4><p>云原生的发展趋势下，应用系统自身的部署、运维变更，都是基于Kubernetes或其它开源CI/CD工具进行的。对于这类下沉场景，AlterShield 提供了 AlterShield Operator，连接各类CI/CD工具到OCMS SDK。同时，Operator 本身也提供了变更流速控制、异常回滚策略控制等能力。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="防控变更引发的风险">防控变更引发的风险<a href="#防控变更引发的风险" class="hash-link" aria-label="防控变更引发的风险的直接链接" title="防控变更引发的风险的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="让变更渐进式灰度生效">让变更渐进式灰度生效<a href="#让变更渐进式灰度生效" class="hash-link" aria-label="让变更渐进式灰度生效的直接链接" title="让变更渐进式灰度生效的直接链接">​</a></h3><p>金丝雀发布的思路来源是，矿井工人发现，金丝雀对瓦斯气体很敏感，矿工会在下井之前，先放一只金丝雀到井中，如果金丝雀不叫了，就代表瓦斯浓度高。 在灰度发布开始后，先启动一个新版本应用，但是并不直接将流量切过来，而是测试人员对新版本进行线上测试，启动的这个新版本应用，就是金丝雀发布模式，下图简单描述了下一个金丝雀的大致逻辑：</p><p><img loading="lazy" src="/zh-CN/assets/images/6-34bc8fa2936e3351099daec543f37ad6.png" width="883" height="758" class="img_ev3q"></p><p>矿井的做法，不再试图分析瓦斯的化学成分，从而找到这种成分的显影试剂从而判断瓦斯是否存在。而是直接通过金丝雀的表象反应(是否健康)来探测所有风险，从而解决了瓦斯以及其他可能的有毒气体的检测问题。而较之全部根因，表象的范围更小、探测手段更明确。
这样一种方式，能够在变更无法充分事前分析出风险的情况下，在真正执行期间，通过控制爆炸半径的方式，让变更可以逐步生效，能够减少未知变更风险引发的稳定性问题影响面，同时再配合上风险防御能力，能够有效的及时发现变更引发的问题，快速做拦截处置恢复动作。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="可干预变更的风险防御能力">可干预变更的风险防御能力<a href="#可干预变更的风险防御能力" class="hash-link" aria-label="可干预变更的风险防御能力的直接链接" title="可干预变更的风险防御能力的直接链接">​</a></h3><p>灰度的核心，是将变更动作拆分为可逐步生效的方式，比如代码发布可以按照机器的环境进行拆解。而一般性的变更，拆解维度不止有环境。我们试图解决变更引发的黑天鹅隐患的主要逻辑是：</p><ul><li>选择在一个<strong>风险可控</strong>的变更范围（这个范围对于稳定性的影响程度是可以接受的），将风险逐步暴露出来。</li><li>再通过变更风险识别防御能力（金丝雀们）去检测变更后是否有异常情况发生。</li></ul><p>于是可以说，以什么维度做拆解，取决于什么因素决定“风险可控”。“可控”意味着范围和风险线性关系。蚂蚁的故障最终表现在对外用户的业务流量上，流量和线性地分布在承载应用进程的机器上，同时，业务线性的分布在包括Pod、PID、UID、业务场景、机房、流量类型等在内的多种维度上。
前置转后置配合线性分批，形成了新的变更范型：</p><p><img loading="lazy" src="/zh-CN/assets/images/7-e50431f9a39153bae37892bea8097b74.png" width="1306" height="575" class="img_ev3q"></p><p>这样一个可灰度/分批的变更防控架构，把原本只能靠体验应急恢复速度来解决的问题，通过一个可控范围暴露风险，再利用充分的风险识别手段，不断将未知的变更风险问题逐步收敛。如果说之前我们期待基于历史归纳的前置规则能够回答所有可能的问题触发根因，从而在问题发生前避免之。那么此时，思路转换成了在每一个小批次之后，回答是否有问题。事实上，所有的问题根因无法穷举，使得前置校验的风险覆盖率低；同时相同根因的变更故障不常复犯，使得前置规则编写的ROI低。但变更对象及其影响面有没有问题，总是更容易回答的，且由于分批的引入，即使前面几个小批次出现了问题，由于范围可控，问题的严重性也可控。
至此，变更风险防控从面向已知问题的防控，演进到了面向未知的防控。从押宝前置校验演进到了前后置共同防控。</p><p>这套可灰度/分批的变更防控架构，有以下几个必要条件：</p><ul><li>固定流程的执行pipeline(强制风险发现/步骤可控)：<ul><li>执行按照预发/灰度/生产批次进行</li><li>环境间/批次间串联</li></ul></li><li>变更分批执行能力(控制风险范围)：<ul><li>变更的生效需要能够区分环境</li><li>线上环境按批次生效</li></ul></li><li>前后置防御校验(风险发现)：<ul><li>前置阻断变更、后置发现问题/阻断下一批次</li><li>变更每批次的前后置需要布防</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="变更防御框架defender-framework">变更防御框架（Defender Framework）<a href="#变更防御框架defender-framework" class="hash-link" aria-label="变更防御框架（Defender Framework）的直接链接" title="变更防御框架（Defender Framework）的直接链接">​</a></h3><p>基于前文的思路，在对平台业务与风险防控团队做了明确的职责划分之后，我们要做的就是为风险防控团队提供一套框架，以便为其提供更灵活、系统化的手段去检测变更过程中的异常，及时地熔断变更。</p><p>为什么需要灵活性？让我们思考一个场景：对于公司内部的管理系统来说，其做系统发布变更时通常只关注系统监控指标和核心日志就够了；但对于对客的业务系统，或者业务上的策略变更，除了关心上述指标外，还需要关注业务本身功能的健康情况（如：对客的展示页面是否白屏、业务活动预算是否充足等）。而且不同的业务变更，其关心的指标还会存在差异。</p><p>上述场景引发的问题是，即使统一了变更的信息差，对于后续的变更防御流程来说，也是不够的。因为<strong>变更防御的观测手段，是随着业务背景不同，而发生灵活变动的</strong>。这就是在之前，变更防御依赖人的经验性的原因所在。</p><p>对于变更风险防控这部分内容，AlterShield将其统称为“变更防御”。共分为：<strong>变更防御框架（Defender Framework）、变更防御能力（Defender Service）、开放扩展服务</strong>三大部分内容。</p><p><img loading="lazy" src="/zh-CN/assets/images/8-6438f49a4ef528bc519fd9b54668818e.png" width="2248" height="752" class="img_ev3q"></p><p>框架层所提供的核心能力是：</p><ol><li>防御能力路由：针对于不同变更，通过表达式配置的形式，路由到不同防御能力集合等待执行检测逻辑。以满足不同变更的防御校验多样性诉求。</li><li>防御能力的调度与并行执行：各防御能力间相互独立，各自负责自己的校验逻辑，并按照一个“统一的结构”进行结果返回。这个结构在后文中会进行阐述。</li><li>防御能力异步化：防御校验本身需要一定的时间（尤其对于可观测性相关的检测来说），这部分时间会带来变更效率的下降（因为操作变更的人员需要等待校验结论）。因此，针对分批次变更的场景下，防御框架提供了异步化校验的能力，利用变更本身执行的时间替换防御校验的时间，做风险与效率的平衡。</li></ol><p><img loading="lazy" src="/zh-CN/assets/images/9-c70a18e7988e00f26ecced49c8abc9d1.png" width="819" height="443" class="img_ev3q">
<img loading="lazy" src="/zh-CN/assets/images/20-b817dded8cd1d8610d0df6aae97ac1cf.png" width="1003" height="686" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="变更防御能力defender-service">变更防御能力（Defender Service）<a href="#变更防御能力defender-service" class="hash-link" aria-label="变更防御能力（Defender Service）的直接链接" title="变更防御能力（Defender Service）的直接链接">​</a></h3><p>如前文所述，对于大部分变更来说，虽然部分使用的防御能力会存在差异（业务语义较强的部分），但大体上所需的防御能力仍是大同小异的（如：可观测性检测、配置变更的值校验、变更操作规范校验等）。这部分我们统称为“通用防御能力”，AlterShield 已在自身框架内部默认集成。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="时序指标异常检测----分批变更监控">时序指标异常检测 -- 分批变更监控<a href="#时序指标异常检测----分批变更监控" class="hash-link" aria-label="时序指标异常检测 -- 分批变更监控的直接链接" title="时序指标异常检测 -- 分批变更监控的直接链接">​</a></h4><p>对于可观测性领域，OpenTelemetry 给出了清晰的三个子领域定义（Metric、Logging、Tracing），其中“Metric”指的就是监控中时序指标（如：CPU利用率、系统RPC服务调用成功率等）。AlterShield 针对时序异常检测，贴合变更分批次执行的背景，建设了“分批变更监控”。</p><p><img loading="lazy" src="/zh-CN/assets/images/10-a8ce24a6d3ec98b8a414a331085afa65.png" width="646" height="320" class="img_ev3q"></p><p>如上如示意，变更场景和普通场景在时序异常检测的区别是，变更场景是有明显的两个时间点的：<strong>变更开始、变更结束。因此，我们在获取到监控时序数据后，主要是做变更前后两段时序的对比异常检测</strong>。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="短时序异常检测">短时序异常检测<a href="#短时序异常检测" class="hash-link" aria-label="短时序异常检测的直接链接" title="短时序异常检测的直接链接">​</a></h5><p>在时序异常检测部分，我们使用了KDE模型进行（Kernel Density Estimation，核密度函数估计）。KDE是统计概率模型之一，统计概率模型是也是比较常见的异常检测思路。数据往往具有其分布规律，如果落在分布边界则触发了小概率事件，即为可能产生了异常。在正态中，99.73% 的数据分布在距平均值三个标准差以内（3-sigma）。那么，如果我们的数据服从一定分布，就可以从分布曲线推断出现当前值的概率。</p><p><img loading="lazy" src="/zh-CN/assets/images/11-2f64fb4b76ac6d696aae699192e4c784.png" width="732" height="531" class="img_ev3q"></p><p>反映到变更场景中，变更前和变更后的时序数据服从一定分布（例如正态分布），那么变更后的当前时间点数据如果超过 N-sigma，则可以判断为异常，一个简要的检测可以描述为：</p><p><img loading="lazy" src="/zh-CN/assets/images/12-79062584fd2cdee87a2a271328c1d19e.png" width="960" height="258" class="img_ev3q"></p><p>三个标准差 3-sigma 是常用的标准，但它的问题是，真实的变更时序数据大部分无法假设其真实分布，即使是一个小时间窗口里的数据分布也很复杂，它不是一个简单的正态分布。相比而言，KDE 是一种非参数估计方法，对数据分布不附加任何假定，只是从数据样本本身出发研究数据分布特征。基于 KDE 的变更时序异常发现，主要流程同 N-sigma，主要是 step2 不同，它需要重新构建变更前样本的数据分布: X1、X2、... Xn 为独立同分布的 n 个样本点，设其概率密度函数为 f，则核密度估计公式为：</p><p><img loading="lazy" src="/zh-CN/assets/images/13-aed970ab4c2fa9694b7c00a0a19dee88.png" width="1000" height="228" class="img_ev3q"></p><p>其中 h 为一个非负的平滑参数，称作带宽， K(.)为核函数(非负、积分为 1，符合概率密度性质，并且均值为 0 )。</p><p>核函数有很多种，例如：uniform、triangular 、biweight、triweight、Epanechnikov、normal 等。依据变更前数据求得概率密度函数 f 后，即可求变更后任意点的概率，进行异常判断。</p><p>另外，仅做变更前后的时序异常比对，极其容易出现由于各类突发、预期内事件导致的指标异动误判。我们回滚并分析了各类误报案例，总结并建设了基于对照组、背景组、历史组的准召率提升方案：</p><ul><li>对照组：同逻辑单元下未变更的服务器采集的指标数据</li><li>背景组：该批次服务器历史n天内的时序指标数据</li><li>历史组：该应用上次同类型变更前后的时序指标数据</li></ul><p><img loading="lazy" src="/zh-CN/assets/images/14-d3baceac058ca7b8e524cb0640e6b8ee.png" width="865" height="750" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="日志异常检测----新增突增异常检测">日志异常检测 -- 新增、突增异常检测<a href="#日志异常检测----新增突增异常检测" class="hash-link" aria-label="日志异常检测 -- 新增、突增异常检测的直接链接" title="日志异常检测 -- 新增、突增异常检测的直接链接">​</a></h4><p>一个系统运行的情况，除了在监控时序指标上可以反映外，另外需要关注的就是其错误日志中，是否有异常堆栈信息，如下图：</p><p><img loading="lazy" src="/zh-CN/assets/images/15-6c6f0ad687d0aa0d783f7b5ff86d63e3.png" width="1413" height="188" class="img_ev3q"></p><p>AlterShield 针对此类日志异常识别场景建设了“新增、突增异常检测”防御能力，检测变更后错误日志中的异常变化情况，共分为两个阶段：</p><ol><li>训练阶段：将通用错误日志中的异常信息进行正则化处理，并将处理后的日志正则模板按照相似度进行分类，构造该系统的日志模板库。</li><li>预测阶段：将系统实时采集异常日志信息同样进行正则化处理，并与模板库中全量模板进行相似度拟合，得出该异常是否为新增异常的结论；针对突增异常，需要计算异常模板计数，预测思路和上文时序异常检测思路相似。</li></ol><p><img loading="lazy" src="/zh-CN/assets/images/16-7a6c7e11a0bd1ebb6c6f08365fec204c.png" width="906" height="600" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="异常相似度计算">异常相似度计算<a href="#异常相似度计算" class="hash-link" aria-label="异常相似度计算的直接链接" title="异常相似度计算的直接链接">​</a></h5><p>在相似度计算上，AlterShield 使用了 Drain 算法，其核心思想是根据各个模板构造固定深度的解析树。当新的异常模板进来时，会与每个已有分支进行相似度计算，不相似则新增分支。</p><p><img loading="lazy" src="/zh-CN/assets/images/17-27d983a921216baff33912d8e75fd1be.png" width="908" height="684" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="链路异常检测----链路错误码检测">链路异常检测 -- 链路错误码检测<a href="#链路异常检测----链路错误码检测" class="hash-link" aria-label="链路异常检测 -- 链路错误码检测的直接链接" title="链路异常检测 -- 链路错误码检测的直接链接">​</a></h4><p>对于单一系统的变更，其影响很可能并不局限于这个系统本身，更可能波及到其上/下游，或整个业务链路的入口/末尾。那么就需要变更后能够具备对整条业务链路进行异常检测的能力。</p><p><img loading="lazy" src="/zh-CN/assets/images/18-206f7233700210b1933080f54eb2edfa.png" width="770" height="522" class="img_ev3q"></p><p>简单模式下，通过trace日志聚合即可反映出系统间每笔流量的调用异常情况以及业务错误码的变化情况，但这种方式的问题在于计算量过于庞大，极度损耗资源。</p><p>那么较为复杂的方式是结合中间件能力，将每笔流量的调用携带特殊标记进行透传染色，这样既能明确感知一笔流量所经过的系统链路，又能在透传的同时携带系统交互的关键信息，从而实现整条链路的异常检测。</p><p>AlterShield 正是借助 Sofa RPC 中间件的能力，将变更信息协议中的唯一标识位在整条流量链路上进行透传。再在链路的入口和末尾处打印全部流量中的业务错误码统计信息。这样，就将链路异常识别问题转换为基于日志的监控指标时序比对问题。后续异常检测的思路大致和“分批变更监控”相同。</p><p>在此你可能有些疑问：如果变更的系统，RPC服务异常导致上/下游根本接收不到消息，就不会在链路的入口和末尾打印统计日志了。那么这类异常怎么识别呢？</p><p>其实，对于RPC服务的来说，各类主流框架都是支持打印统计日志的。一旦出现失败量突升，在统计日志中即可反映出来。所以，这个问题是属于“单系统的监控时序指标校验”范畴，也就是说利用前文提到的“分批变更监控”就可校验出来。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="配置值自适应校验">配置值自适应校验<a href="#配置值自适应校验" class="hash-link" aria-label="配置值自适应校验的直接链接" title="配置值自适应校验的直接链接">​</a></h4><p>对于配置类型的变更（如：分布式内存配置变更、营销活动配置变更等），一旦提单人员疏忽填写错误或遗漏，也会导致线上问题。同时，这类配置可能数量极其庞大（在蚂蚁集团内部有上千万+），靠人工进行梳理是不现实的。</p><p>因此，对于历史上正常完结没有回滚的配置变更，AlterShield 根据其变更值进行特征提取，学习该配置的key、value变化规律，从统计学、正则、枚举等多个角度构造每个配置值的特征组。当新变更到来时，就转化成了特征相似匹配，从而发现人工填写错误的问题。</p><p><img loading="lazy" src="/zh-CN/assets/images/19-2baaaeada2c940ea89e188826b5ab5db.png" width="938" height="422" class="img_ev3q"></p><p>另外，除 AlterShield 提供的上述防御能力外，风险防控人员也可将自己在特定业务背景下的专家经验，以Plugin、SPI扩展的形式沉淀到 AlterShield 中，并以配置化的形式进行路由设置，生效到指定变更中。</p><h1>社区建设</h1><p>变更管控领域是提升生产环境稳定性的一个重要领域。相关的技术标准也在逐步完善建设起来，并推动这一领域的演进。在这样的背景下，我们也希望将 AlterShield 在蚂蚁5年的实践经验开放出来，与各行业的领域专家一起探讨学习，并逐渐丰富 AlterShield 自身能力与社区建设。</p><p>我们的开源工作在陆续准备中，当前还只是我们的0.1版本。首期我们会开源 AlterShield 的 OCMS + Operator体系。接下来我们的计划如下：</p><ol><li>提供完善的开箱即用及Q&amp;A手册</li><li>完善 Operator 能力：提供完整的变更策略控制、回滚策略控制能力。</li><li>扩展 Operator 生态：集成更多的开源CI/CD工具当中，丰富感知及防控场景。</li><li>原生防御能力下沉：在 Operator 中直接提供对接监控工具服务及异常校验能力。</li><li>完善可观测性异常检测生态：集成更多的开源监控工具，提供异常检测能力。</li><li>开源完整的Defender模块：包含防御框架、防御能力及开放扩展部分。</li><li>开源完整的Analyser模块：包含分析框架、影响面分析、风险分析、可观测性分析及变更分级部分。</li><li>开放独立的防御校验能力：使防御框架独立于OCMS SDK，无需接入改造，即可进行变更防控校验。</li></ol><p>作为开源社区，我们欢迎各种形式的贡献，您可以参与到社区的共建的形式包括但不限于：</p><ul><li>错别字修正：帮助我们指正文档中的错误。</li><li>问题及案例探讨：您公司中的变更故障案例，脱敏后可参与讨论，一期探讨解决方案。</li><li>Bug提交：帮助我们指出 AlterShield 中逻辑错误的地方。</li><li>新功能场景探讨：任何 AlterShield 还不具备的变更领域功能，都可以一起讨论。</li><li>完善 OCMS 协议：目前 OCMS 开源还处于0.1版本，如果在您的场景下有不能适配的情况，您可以直接参与讨论及扩充。</li><li>完善 Operator 生态：目前 Operator 在0.1版本会对接Kubernetes Deployment，您可以在您的CI/CD工具下改造及对接 Operator，扩展其生态。</li><li>对接更多监控工具：您可以将您所使用的监控工具对接到 AlterShield 提供的可观测性防御能力中，扩展 AlterShield 的检测能力范围。</li><li>沉淀您的变更防御专家经验：您可以以Plugin、SPI扩展的形式，将您的变更防御专家经验沉淀到 AlterShield 中。</li></ul>]]></content>
        <author>
            <name>Yalong Jin</name>
            <uri>https://github.com/jinyalong</uri>
        </author>
        <author>
            <name>Yuefan Wang</name>
            <uri>https://github.com/yvan-wyf</uri>
        </author>
        <author>
            <name>Haouan Yu</name>
            <uri>https://github.com/yhaoxuan</uri>
        </author>
        <category label="SRE" term="SRE"/>
        <category label="DevOps" term="DevOps"/>
        <category label="OCMS" term="OCMS"/>
        <category label="AlterShield" term="AlterShield"/>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="AIOps" term="AIOps"/>
    </entry>
</feed>