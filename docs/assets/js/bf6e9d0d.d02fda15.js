"use strict";(self.webpackChunkguide=self.webpackChunkguide||[]).push([[930],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),d=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=d(e.components);return a.createElement(s.Provider,{value:t},e.children)},u="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=d(n),p=o,m=u["".concat(s,".").concat(p)]||u[p]||h[p]||r;return n?a.createElement(m,i(i({ref:t},c),{},{components:n})):a.createElement(m,i({ref:t},c))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:o,i[1]=l;for(var d=2;d<r;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},8827:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>l,toc:()=>d});var a=n(7462),o=(n(7294),n(3905));const r={},i="Overall Design",l={unversionedId:"altershield-operator/overall-design",id:"altershield-operator/overall-design",title:"Overall Design",description:"This document introduces the overall design of AlterShield Operator.",source:"@site/docs/05-altershield-operator/07-overall-design.md",sourceDirName:"05-altershield-operator",slug:"/altershield-operator/overall-design",permalink:"/altershield-operator/overall-design",draft:!1,tags:[],version:"current",sidebarPosition:7,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Advanced Usage",permalink:"/altershield-operator/advanced-usage"}},s={},d=[{value:"1. Source directory introduction",id:"1-source-directory-introduction",level:2},{value:"2. Architecture design",id:"2-architecture-design",level:2},{value:"2.1. Design target",id:"21-design-target",level:3},{value:"2.1.1. Version confirmation and release control",id:"211-version-confirmation-and-release-control",level:4},{value:"2.1.2. Real-time monitoring",id:"212-real-time-monitoring",level:4},{value:"2.1.3. Release status summary",id:"213-release-status-summary",level:4},{value:"2.1.4. Release status verification",id:"214-release-status-verification",level:4},{value:"2.1.5. Configuration update",id:"215-configuration-update",level:4},{value:"2.2. System composition",id:"22-system-composition",level:3},{value:"2.3. System flow",id:"23-system-flow",level:3},{value:"3. Webhook debugging",id:"3-webhook-debugging",level:2},{value:"3.1. Local debugging",id:"31-local-debugging",level:3},{value:"3.2. Exporting Certificates from the Cluster",id:"32-exporting-certificates-from-the-cluster",level:3},{value:"3.3. Local launch and debugging",id:"33-local-launch-and-debugging",level:3}],c={toc:d},u="wrapper";function h(e){let{components:t,...r}=e;return(0,o.kt)(u,(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"overall-design"},"Overall Design"),(0,o.kt)("p",null,"This document introduces the overall design of AlterShield Operator."),(0,o.kt)("h2",{id:"1-source-directory-introduction"},"1. Source directory introduction"),(0,o.kt)("p",null,"The directory structure of AlterShield Operator's source code is as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"./apis/\n./bin/\n./certs/\n./config/\n./controllers/\n./routers/\n./main.go\n./Makefile\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"apis/"),"\uff1aContains the API for custom CRD (Custom Resource Definition) as well as the struct definitions related to Kubernetes' native API."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"bin/"),"\uff1aContains the executable file for AlterShield Operator."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"certs/"),"\uff1aContains the certificate files for AlterShield Operator, used for local debugging of Webhook."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"config/"),"\uff1aContains the configuration files for AlterShield Operator."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"controllers/"),"\uff1aContains the controller code for AlterShield Operator."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"routers/"),"\uff1aContains the router code for communication between AlterShield Operator and AlterShield Server."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"runnable/"),"\uff1aContains the background task code for AlterShield Operator."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"main.go"),"\uff1aThe entry file for AlterShield Operator."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Makefile"),"\uff1aThe compilation file for AlterShield Operator.")),(0,o.kt)("h2",{id:"2-architecture-design"},"2. Architecture design"),(0,o.kt)("h3",{id:"21-design-target"},"2.1. Design target"),(0,o.kt)("p",null,"As a Kubernetes Operator, the main function of AlterShield Operator is to control Workload by listening to CRD in Kubernetes and communicating with AlterShield Server. Specifically, the design goals of AlterShield Operator are as follows:"),(0,o.kt)("h4",{id:"211-version-confirmation-and-release-control"},"2.1.1. Version confirmation and release control"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Use Webhook to confirm the version and release control of Workload in Kubernetes. When a user submits a new version of Workload, AlterShield Operator sends a request through Webhook to confirm the version and release control with AlterShield Server, ensuring that the submitted version complies with security standards and can be deployed correctly to the Kubernetes cluster.")),(0,o.kt)("h4",{id:"212-real-time-monitoring"},"2.1.2. Real-time monitoring"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Use Watch to monitor Workload and Pod in Kubernetes in real-time. When a change occurs in Workload or Pod in Kubernetes, AlterShield Operator detects and processes it in real-time to ensure that the status of Workload and Pod in the Kubernetes cluster is synchronized with AlterShield Server.")),(0,o.kt)("h4",{id:"213-release-status-summary"},"2.1.3. Release status summary"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Use ChangeWorkload to summarize the release status of Workload in Kubernetes. When a user submits a new version of Workload, AlterShield Operator records its status in ChangeWorkload and periodically sends requests to AlterShield Server to update the release status of Workload. This way, users can easily check the release status and change history of Workload.")),(0,o.kt)("h4",{id:"214-release-status-verification"},"2.1.4. Release status verification"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Use ChangePod and communication with AlterShield Server to verify the release status of Pod in Kubernetes. When a change occurs in Pod in Kubernetes, AlterShield Operator checks its status and verifies its release status through communication with AlterShield Server.")),(0,o.kt)("h4",{id:"215-configuration-update"},"2.1.5. Configuration update"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Use OpsConfigInfo to update the configuration of Operator. When a user needs to modify the configuration of AlterShield Operator, they can modify the parameters in OpsConfigInfo to achieve the desired effect. AlterShield Operator will detect the changes in parameters in a timely manner and update its configuration accordingly.")),(0,o.kt)("h3",{id:"22-system-composition"},"2.2. System composition"),(0,o.kt)("p",null,"AlterShield Operator consists of the following components:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Controller\uff1aResponsible for listening to CR and custom CRD in Kubernetes and responding accordingly."),(0,o.kt)("li",{parentName:"ul"},"Webhook\uff1aResponsible for version confirmation and release control of Workload in Kubernetes."),(0,o.kt)("li",{parentName:"ul"},"Router\uff1aResponsible for callback processing between AlterShield Operator and AlterShield Server."),(0,o.kt)("li",{parentName:"ul"},"Runnable\uff1aResponsible for asynchronous background tasks.")),(0,o.kt)("h3",{id:"23-system-flow"},"2.3. System flow"),(0,o.kt)("p",null,"The operating process of AlterShield Operator is as follows:\n",(0,o.kt)("img",{alt:"img.png",src:n(289).Z,width:"2000",height:"826"}),"\nThe relationship between Operator Controller is as follows:\n",(0,o.kt)("img",{alt:"img_1.png",src:n(3820).Z,width:"1392",height:"614"})),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"The Webhook listens to the Deployment in Kubernetes. If the Template of the Deployment is changed, it updates the Version Label of the Deployment and determines whether to block the release. The Version Label is a label used to mark the version of the Deployment. Whenever the Template of the Deployment is changed, the value of the Version Label will be updated accordingly. This label helps AlterShield Operator to perform version control and management."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:2},(0,o.kt)("li",{parentName:"ol"},"The Deployment Controller listens to the Deployment in Kubernetes and creates a corresponding version of ChangeWorkload. ChangeWorkload is a custom resource type in AlterShield Operator that records the version change history of the Deployment. When the Template of the Deployment is changed, the Deployment Controller creates a new ChangeWorkload to record the information of the new version of the Deployment."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:3},(0,o.kt)("li",{parentName:"ol"},"The Pod Controller listens to the Pod in Kubernetes and determines whether it is a finished Pod. If it is, it adds a Finished Label. The Finished Label is a label used to mark the finished Pod, which helps AlterShield Operator locate the finished Pod and calculate the number of finished Pods."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:4},(0,o.kt)("li",{parentName:"ol"},"The ChangeWorkload Controller listens to the ChangeWorkload and finished Pod in Kubernetes. When the number of finished Pods reaches the threshold, it creates a ChangePod in the Init state. ChangePod is another custom resource type in AlterShield Operator that records the status and callback results of the released Pods. When the number of finished Pods reaches the threshold, the ChangeWorkload Controller creates a ChangePod in the Init state, which will pass the Pod information to the AlterShield Server in the future."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:5},(0,o.kt)("li",{parentName:"ol"},"The ChangePod Controller listens to the ChangePod in Kubernetes. When the status of the ChangePod is Init, it selects no more than the threshold number of Finished Pods and passes the information to the AlterShield Server to achieve the callback function through Router and CallBack Handle. The ChangePod Controller listens to the callback results of the AlterShield Server and updates the status of the ChangePod according to the callback results."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:6},(0,o.kt)("li",{parentName:"ol"},"The ChangePod Controller listens to the ChangePod in Kubernetes. When the status of the ChangePod is Callback Finished, it updates the status of the ChangePod according to the callback results and sets the status of the ChangePod to Done. It then sends this information to the ChangeWorkload Controller."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:7},(0,o.kt)("li",{parentName:"ol"},"The ChangeWorkload Controller listens to the ChangeWorkload and Done ChangePod in Kubernetes. It updates the status of the ChangeWorkload according to the status of the ChangePod and determines whether to block the release. If the status of all the Pods in the ChangePod passes the verification, the ChangeWorkload Controller will update the status of the ChangeWorkload to Success. Otherwise, it will update it to Suspend."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:8},(0,o.kt)("li",{parentName:"ol"},"The Rollback Runnable checks the Pod in Kubernetes. If a Pod has not reached the Running state for a long time (default 2 minutes), it triggers the Rollback mechanism. Rollback Runnable is a background task in AlterShield Operator used to check the status of Pods. If a Pod has been in a non Running state for a long time, it triggers an automatic rollback operation to ensure the stability of the Kubernetes cluster."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:9},(0,o.kt)("li",{parentName:"ol"},"The Rollback Runnable listens to the ChangeWorkload in Kubernetes. When the status of the ChangeWorkload is Rollback, it triggers the Rollback mechanism. The Rollback Runnable also listens to the status of the ChangeWorkload. If the status of the ChangeWorkload is Rollback, it triggers an automatic rollback operation to ensure the stability of the Kubernetes cluster. (Under construction)")))),(0,o.kt)("h2",{id:"3-webhook-debugging"},"3. Webhook debugging"),(0,o.kt)("h3",{id:"31-local-debugging"},"3.1. Local debugging"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"This article will take ",(0,o.kt)("a",{parentName:"strong",href:"https://minikube.sigs.k8s.io/"},"MINIKUBE")," as an example to introduce how to debug Webhook locally.")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"Start MiniKube")))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"minikube start --driver=docker\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:2},(0,o.kt)("li",{parentName:"ol"},"use minikube ssh to confirm connectivity")))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"minikube ssh\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:3},(0,o.kt)("li",{parentName:"ol"},"Get the IP address that is accessible from the cluster to the host")))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"# ping host.minikube.internal\nPING host.minikube.internal (192.168.64.1): 56 data bytes\n64 bytes from 192.168.64.1: seq=0 ttl=64 time=0.225 ms\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:4},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"192.168.64.1")," is the IP address that is accessible from the cluster to the host\uff0cModify ",(0,o.kt)("inlineCode",{parentName:"li"},"{IP_Address}")," in ",(0,o.kt)("inlineCode",{parentName:"li"},"config/dev/kustomization.yaml")," to 192.168.64.1.")))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'bases:\n  - ../default\n\npatches:\n  - patch: |\n      - op: "remove"\n        path: "/spec/dnsNames"\n    target:\n      kind: Certificate\n  - patch: |\n      - op: "add"\n        path: "/spec/ipAddresses"\n        value: ["{IP_Address}"]\n    target:\n      kind: Certificate\n  - patch: |\n      - op: "add"\n        path: "/webhooks/0/clientConfig/url"\n        value: "https://{IP_Address}:1443/mutate-apps-v1-deployment"\n    target:\n      kind: MutatingWebhookConfiguration\n  - patch: |\n      - op: "add"\n        path: "/webhooks/0/clientConfig/url"\n        value: "https://{IP_Address}:1443/validate-apps-v1-deployment"\n    target:\n      kind: ValidatingWebhookConfiguration\n  - patch: |\n      - op: "remove"\n        path: "/webhooks/0/clientConfig/service"\n    target:\n      kind: MutatingWebhookConfiguration\n  - patch: |\n      - op: "remove"\n        path: "/webhooks/0/clientConfig/service"\n    target:\n      kind: ValidatingWebhookConfiguration\n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:6},(0,o.kt)("li",{parentName:"ol"},"After modification, execute the command to deploy the debug version")))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"make dev\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:7},(0,o.kt)("li",{parentName:"ol"},"Use the following command to check whether the Webhook has been successfully deployed.")))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get mutatingwebhookconfigurations.admissionregistration.k8s.io altershieldoperator-mutating-webhook-configuration -o yaml\nkubectl get validatingwebhookconfigurations.admissionregistration.k8s.io altershieldoperator-validating-webhook-configuration -o yaml\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: admissionregistration.k8s.io/v1\nkind: MutatingWebhookConfiguration\nmetadata:\n  annotations:\n    cert-manager.io/inject-ca-from: altershieldoperator-system/altershieldoperator-serving-cert\n    kubectl.kubernetes.io/last-applied-configuration: |\n      {"apiVersion":"admissionregistration.k8s.io/v1","kind":"MutatingWebhookConfiguration","metadata":{"annotations":{"cert-manager.io/inject-ca-from":"altershieldoperator-system/altershieldoperator-serving-cert"},"labels":{"app.kubernetes.io/component":"webhook","app.kubernetes.io/created-by":"altershieldoperator","app.kubernetes.io/instance":"mutating-webhook-configuration","app.kubernetes.io/managed-by":"kustomize","app.kubernetes.io/name":"mutatingwebhookconfiguration","app.kubernetes.io/part-of":"altershieldoperator"},"name":"altershieldoperator-mutating-webhook-configuration"},"webhooks":[{"admissionReviewVersions":["v1"],"clientConfig":{"url":"https://192.168.65.2:1443/mutate-apps-v1-deployment"},"failurePolicy":"Fail","name":"mdeployment.kb.io","namespaceSelector":{"matchLabels":{"admission-webhook-altershield":"enabled"}},"rules":[{"apiGroups":["apps"],"apiVersions":["v1"],"operations":["CREATE","UPDATE"],"resources":["deployments"]}],"sideEffects":"None"}]}\n  creationTimestamp: "2023-05-11T07:29:29Z"\n  generation: 2\n  labels:\n    app.kubernetes.io/component: webhook\n    app.kubernetes.io/created-by: altershieldoperator\n    app.kubernetes.io/instance: mutating-webhook-configuration\n    app.kubernetes.io/managed-by: kustomize\n    app.kubernetes.io/name: mutatingwebhookconfiguration\n    app.kubernetes.io/part-of: altershieldoperator\n  name: altershieldoperator-mutating-webhook-configuration\n  resourceVersion: "197855"\n  uid: 1b417fb7-2deb-47c1-a006-67a352a90d2e\nwebhooks:\n  - admissionReviewVersions:\n      - v1\n    clientConfig:\n      caBundle: ...\n      url: https://192.168.64.1:1443/mutate-apps-v1-deployment\n    failurePolicy: Fail\n    matchPolicy: Equivalent\n    name: mdeployment.kb.io\n    namespaceSelector:\n      matchLabels:\n        admission-webhook-altershield: enabled\n    objectSelector: {}\n    reinvocationPolicy: Never\n    rules:\n      - apiGroups:\n          - apps\n        apiVersions:\n          - v1\n        operations:\n          - CREATE\n          - UPDATE\n        resources:\n          - deployments\n        scope: \'*\'\n    sideEffects: None\n    timeoutSeconds: 10\n---\napiVersion: admissionregistration.k8s.io/v1\nkind: ValidatingWebhookConfiguration\nmetadata:\n  annotations:\n    cert-manager.io/inject-ca-from: altershieldoperator-system/altershieldoperator-serving-cert\n    kubectl.kubernetes.io/last-applied-configuration: |\n      {"apiVersion":"admissionregistration.k8s.io/v1","kind":"ValidatingWebhookConfiguration","metadata":{"annotations":{"cert-manager.io/inject-ca-from":"altershieldoperator-system/altershieldoperator-serving-cert"},"labels":{"app.kubernetes.io/component":"webhook","app.kubernetes.io/created-by":"altershieldoperator","app.kubernetes.io/instance":"validating-webhook-configuration","app.kubernetes.io/managed-by":"kustomize","app.kubernetes.io/name":"validatingwebhookconfiguration","app.kubernetes.io/part-of":"altershieldoperator"},"name":"altershieldoperator-validating-webhook-configuration"},"webhooks":[{"admissionReviewVersions":["v1"],"clientConfig":{"url":"https://192.168.65.2:1443/validate-apps-v1-deployment"},"failurePolicy":"Fail","name":"vdeployment.kb.io","namespaceSelector":{"matchLabels":{"admission-webhook-altershield":"enabled"}},"rules":[{"apiGroups":["apps"],"apiVersions":["v1"],"operations":["CREATE","UPDATE"],"resources":["deployments"]}],"sideEffects":"None"}]}\n  creationTimestamp: "2023-05-11T07:29:29Z"\n  generation: 2\n  labels:\n    app.kubernetes.io/component: webhook\n    app.kubernetes.io/created-by: altershieldoperator\n    app.kubernetes.io/instance: validating-webhook-configuration\n    app.kubernetes.io/managed-by: kustomize\n    app.kubernetes.io/name: validatingwebhookconfiguration\n    app.kubernetes.io/part-of: altershieldoperator\n  name: altershieldoperator-validating-webhook-configuration\n  resourceVersion: "197856"\n  uid: b3ea5378-1d88-491a-8c10-0e40e5495852\nwebhooks:\n  - admissionReviewVersions:\n      - v1\n    clientConfig:\n      caBundle: ...\n      url: https://192.168.64.1:1443/validate-apps-v1-deployment\n    failurePolicy: Fail\n    matchPolicy: Equivalent\n    name: vdeployment.kb.io\n    namespaceSelector:\n      matchLabels:\n        admission-webhook-altershield: enabled\n    objectSelector: {}\n    rules:\n      - apiGroups:\n          - apps\n        apiVersions:\n          - v1\n        operations:\n          - CREATE\n          - UPDATE\n        resources:\n          - deployments\n        scope: \'*\'\n    sideEffects: None\n    timeoutSeconds: 10\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Note\uff1a")," In the above configuration, the Webhook service will call the 1443 port on the local machine. If there is a Deployment release, it will fail due to certificate issues, so the certificate needs to be exported to the local project."),(0,o.kt)("h3",{id:"32-exporting-certificates-from-the-cluster"},"3.2. Exporting Certificates from the Cluster"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Run the following command to view the certificates in the cluster:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get secret -n altershieldoperator-system -o yaml \n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: v1\nitems:\n  - apiVersion: v1\n    data:\n      ca.crt: ...\n      tls.crt: ...\n      tls.key: ...\n    kind: Secret\n    metadata:\n      annotations:\n        cert-manager.io/alt-names: ""\n        cert-manager.io/certificate-name: altershieldoperator-serving-cert\n        cert-manager.io/common-name: ""\n        cert-manager.io/ip-sans: 192.168.65.2\n        cert-manager.io/issuer-group: ""\n        cert-manager.io/issuer-kind: Issuer\n        cert-manager.io/issuer-name: altershieldoperator-selfsigned-issuer\n        cert-manager.io/uri-sans: ""\n      creationTimestamp: "2023-05-11T07:29:29Z"\n      name: webhook-server-cert\n      namespace: altershieldoperator-system\n      resourceVersion: "197854"\n      uid: 25261ced-e462-4634-910c-d5862ed60720\n    type: kubernetes.io/tls\nkind: List\nmetadata:\n  resourceVersion: ""\n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Export the certificate to the local project:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl get secrets webhook-server-cert -n  altershieldoperator-system -o jsonpath='{..tls\\.crt}' |base64 -d > ./certs/tls.crt\nkubectl get secrets webhook-server-cert -n  altershieldoperator-system -o jsonpath='{..tls\\.key}' |base64 -d > ./certs/tls.key\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"View the certificate files in the local project:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"#cat ./certs/tls.crt\n-----BEGIN CERTIFICATE-----\nMIICvzCCAaegAwIBAgIRAO3ytpgp5rNYOJ7X8dmJBoEwDQYJKoZIhvcNAQELBQAw\nADAeFw0yMzA1MTEwNzI5MjlaFw0yMzA4MDkwNzI5MjlaMAAwggEiMA0GCSqGSIb3\nDQEBAQUAA4IBDwAwggEKAoIBAQDq5AkCmWdCKB/H2dDgiikvl0T66tnSiA2CnYme\nBuoGhWLZyo0zwF+XTrbdbjsswdY0zliv4dfv4i+4vgdI0lP2uM4YdCYEw5vog68n\nb7t1jwMbT8ipBqLxOWaGcqBidOrVFrUvs89gQDa1gNyUvBivzwyfTwxV/4EPf7ic\n5mr7gMJY7akKz6u/zTuIL2h+C0wmge/xmfDzLKE9QY/H021Pq12X0G7tLDqweFQO\n6tJTMqgICQaLCvas+iYdYReLdQDPIylFYb8Pw87f+AJB+snucmwNQWOlZTvaFi6p\nS4b5NoDilUlAXco9cIS43w8JjyqzT3/Lw7+MiAJavwXe5wpxAgMBAAGjNDAyMA4G\nA1UdDwEB/wQEAwIFoDAMBgNVHRMBAf8EAjAAMBIGA1UdEQEB/wQIMAaHBMCoQQIw\nDQYJKoZIhvcNAQELBQADggEBAH0HQVrF0cdmK8F+eWJyY49Q9pR/h3EqGGHOmJEv\nXFuPdL22n4hRV+7rRtveBX1nsuKRapdqrocyB80LrtociinQL61fxsS2eb85xOho\nCfP33rIOvlaBGhZwlBWnUJmIsfbKpW0/xDKFgmeusHfV1OoClz8IKjkGGqq1s0Uw\nDSW/2emxFIeGi2mrrIr3T2XZ153MKNYOZ4oYURi6iuPr2zGpvKh6OZjoHIjcAhQK\nBX+djGGOa9rLgtx0b1GHqj6GYgd9y4ygQXjVvTG1wUIOapN7bU2R2cs/WiwcCk8U\nnnp48sVBVYlEPxea1GmxmJPloMYVZqiXg5uOEa65Lzt+RbE=\n-----END CERTIFICATE-----\n\n#cat ./certs/tls.key\n-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA6uQJAplnQigfx9nQ4IopL5dE+urZ0ogNgp2JngbqBoVi2cqN\nM8Bfl0623W47LMHWNM5Yr+HX7+IvuL4HSNJT9rjOGHQmBMOb6IOvJ2+7dY8DG0/I\nqQai8TlmhnKgYnTq1Ra1L7PPYEA2tYDclLwYr88Mn08MVf+BD3+4nOZq+4DCWO2p\nCs+rv807iC9ofgtMJoHv8Znw8yyhPUGPx9NtT6tdl9Bu7Sw6sHhUDurSUzKoCAkG\niwr2rPomHWEXi3UAzyMpRWG/D8PO3/gCQfrJ7nJsDUFjpWU72hYuqUuG+TaA4pVJ\nQF3KPXCEuN8PCY8qs09/y8O/jIgCWr8F3ucKcQIDAQABAoIBABT4dOF5hqF+aY/z\nH1Xcn96y16K7MuU75lDh9bZZEa2xXOjqz35uT1p32ZWdUMUnLROb1IknVZsCC5an\nyIi01nAxgZznSbmlKRcyIoIX1JmjQfi/P7/var60jDW2qCECJTEPDPAMUphaQ0gj\nEA5rWJzhlFPov8YxwHj8wyOm4qg/Y8nAHSawS6t0v7MQlym/LNKY/JUJ5rZBLH3/\nMBypwzcSGPCiMnn7BjN294DbH/zcijWjKnv96fd8IfSAfyI4V8e60yqa4O0gR01e\naRTP6EKy/8k2mIJq0ub8AguD+tfSdHFQotQGzvIQYczNZDabE2MAcyLVJNq4Yaua\n/AIpjAECgYEA/mqCNoz2fBeigXFgr6EfVpEk7HEDPvbdkOI8eCUJoiQdN2XHvXIH\nFfLT/1BdMuoEJGpO/zVCvSsT2QYh5upUuxvEzUZYUR8zHMnQTEpI9ErtmCoFZmte\ndZbCFNmYps5z1R+Ze7O/3PlE62S00D4FcrBaGTFWKuuKFldbu0k2N7ECgYEA7Fpo\nK4hUYScTnlBfwQeyku4PNm4PVXDUIOME0zZfkPEhjaPJSkJrRZ8urhidEw0aFAmm\nPzN2UgkXuRb27PShTOqwnrN5G674XzvAbv14eIyUsFnJ78s6kHR3oIxciO6LAVpd\nwpT9WpE/xm4lY1RBC4h073Nug1owWi8zLgHpbsECgYEAwEzBH3ps1F8I9c48xoOC\nrGwI/K5vRahS0LAwBJ/6KBQkATttPkRyFqT0mIal61X2y4+PJlebmmB1IBUCiweU\nA9l5Z69EEg0DFT91sjRz8DKyY9FfQ4rkWv0YtanDOFHUO8Mmv9mdq+i9ry7vfHdk\npsulTmV8O/TM6xYcv/MWiAECgYEAwDQZCGW6MLNladX0uHX5CzFa36mLALFbYE8d\nSmGqP6VH4vYxqBjxQVHc1Skg+zApZ+gc8MJ50uagCx2YukOJtJIaBUTwFMoqIs/l\ngpzPzkCMXgj2hfGf838zFTVvvs817Wi+XJFqoq8BzO0frHIE30sdxOf7FAhQz9YY\naa6WVUECgYBuXdVg6zcw4YxnrWGMw7k0+vzeJF8PlNF0ajXlXEwlUJVrTFOABTwk\n2d3hBI4h060PE8f+3QClEPgh1+sc8RhkLRoOUkRzFghMssKa8CKPBkG7BTpkV4Wv\nbEls6FRqab96RlpLk+hjNnsCxl+EcKklxEYVXC+cRKeZERt6g7gfZg==\n-----END RSA PRIVATE KEY-----\n\n")),(0,o.kt)("h3",{id:"33-local-launch-and-debugging"},"3.3. Local launch and debugging"),(0,o.kt)("p",null,"During the development process of Webhook, you can launch locally using the following steps:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"./quick-start"},"Quick Start"))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"At this point, when a Deployment is released in the Namespace controlled by the cluster, it will trigger the call of the Webhook to the local machine, and you can see the log output of the Webhook")))}h.isMDXComponent=!0},3820:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/controller-fbe8a91f098797ae854b4f53cb302aab.png"},289:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/img-bcb9a9f0606e8aaa71a60c173c552128.png"}}]);